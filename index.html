<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Genesis // Inversion</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700;800&family=Inter:wght@400;700;900&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0a0a0a;
            color: #d1d5db;
        }
        .font-mono {
            font-family: 'JetBrains Mono', monospace;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #111; border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
    </style>
</head>
<body class="min-h-screen p-4 flex flex-col selection:bg-cyan-900">

    <!-- HEADER -->
    <header class="flex justify-between items-end border-b border-gray-700 pb-2 mb-4">
        <div>
            <h1 class="text-2xl font-black tracking-tighter text-white">PROJECT GENESIS <span class="text-cyan-500">//</span> INVERSION</h1>
            <h2 class="text-sm font-mono text-gray-500 uppercase tracking-widest mt-1">Sim3Colts Build :: Rulial Mechanics v2</h2>
        </div>
        <div class="text-right font-mono text-xs text-gray-500">
            STATUS: <span class="text-lime-500 animate-pulse">ONLINE</span><br/>
            ENGINE: RULIAD_KINEMATICS_X1
        </div>
    </header>

    <!-- MAIN GRID -->
    <div class="flex-1 grid grid-cols-1 lg:grid-cols-3 gap-6">
        
        <!-- LEFT PANE: CANVAS & CONTROLS -->
        <div class="lg:col-span-2 flex flex-col gap-4">
            
            <!-- SIMULATION VIEWPORT -->
            <div class="relative w-full h-[500px] bg-black border border-gray-800 rounded shadow-[0_0_30px_rgba(0,255,255,0.05)] overflow-hidden" id="canvas-container">
                <canvas id="simCanvas" class="absolute inset-0 w-full h-full"></canvas>
                <div class="absolute top-2 left-2 text-[10px] font-mono text-gray-500 select-none pointer-events-none">
                    GEOMETRY: SQUARE_STRICT<br/>
                    RAY_SPLIT: OFF
                </div>
            </div>

            <!-- SIMULATION CONTROLS -->
            <div class="grid grid-cols-2 gap-4 bg-gray-900 p-4 border border-gray-800 rounded font-mono text-xs">
                <div>
                    <label class="flex justify-between text-gray-400 mb-1">
                        <span>SONIC DRIVE (Time Δt)</span>
                        <span class="text-cyan-400" id="speedLabel">x5</span>
                    </label>
                    <input type="range" id="speedInput" min="1" max="50" value="5" class="w-full accent-cyan-500" />
                </div>
                <div>
                    <label class="flex justify-between text-gray-400 mb-1">
                        <span>SMITH TRAIL MEMORY</span>
                        <span class="text-magenta-400" id="trailLabel">800 steps</span>
                    </label>
                    <input type="range" id="trailInput" min="10" max="1000" value="800" class="w-full accent-magenta-500" />
                </div>
            </div>
        </div>

        <!-- RIGHT PANE: QUADRATIC REALITY MATRIX & OBSERVABLES -->
        <div class="flex flex-col gap-4 h-full">
            
            <!-- MACRO OBSERVABLES DASHBOARD -->
            <div class="bg-gray-900 p-4 border border-gray-800 rounded grid grid-cols-2 gap-y-4 gap-x-2 font-mono text-xs">
                <div class="col-span-2 border-b border-gray-800 pb-1 mb-1 text-gray-500 font-bold tracking-widest">
                    SYSTEM MACROSTATES
                </div>
                
                <div class="flex flex-col">
                    <span class="text-gray-500">AGG. WINDING ($W$)</span>
                    <span class="text-xl text-cyan-400 font-bold" id="statWinding">0.000</span>
                </div>
                
                <div class="flex flex-col">
                    <span class="text-gray-500">CORNER HITS (ε)</span>
                    <span class="text-xl text-magenta-400 font-bold" id="statCorners">0</span>
                </div>

                <div class="flex flex-col">
                    <span class="text-gray-500">BOUNDARY IMPACTS</span>
                    <span class="text-lg text-white" id="statBounces">0</span>
                </div>

                <div class="flex flex-col">
                    <span class="text-gray-500">FREE CONFIGS</span>
                    <span class="text-lg text-white" id="statConfigs">180,360</span>
                </div>
            </div>

            <!-- QUADRATIC REALITY MATRIX TABS -->
            <div class="flex-1 flex flex-col border border-gray-800 rounded overflow-hidden bg-black min-h-[300px]">
                <div class="flex bg-gray-900 border-b border-gray-800 text-[10px] font-mono overflow-x-auto" id="tab-headers">
                    <!-- Tab buttons generated by JS -->
                </div>
                
                <div class="flex-1 p-2 relative">
                    <!-- EYES TAB -->
                    <div id="tab-EYES" class="hidden h-full flex flex-col font-mono text-xs text-blue-400 p-4 bg-gray-900 border border-blue-800 rounded">
                        <h3 class="text-blue-200 mb-2 border-b border-blue-800 pb-1">SENSORY RECEPTORS (HEATMAP)</h3>
                        <div class="flex-1 relative bg-black border border-blue-900 overflow-hidden">
                            <canvas id="eyesCanvas" class="absolute inset-0 w-full h-full opacity-80"></canvas>
                        </div>
                    </div>

                    <!-- BRAIN TAB -->
                    <div id="tab-BRAIN" class="hidden h-full flex flex-col font-mono text-xs text-purple-400 p-4 bg-gray-900 border border-purple-800 rounded">
                        <h3 class="text-purple-200 mb-2 border-b border-purple-800 pb-1">COGNITIVE HEURISTICS (AVOIDANCE)</h3>
                        <div class="flex-1 flex flex-col gap-2">
                            <div class="bg-black p-2 border border-purple-900">
                                <p class="text-gray-500">BLADE PERTURBATION PROTOCOL</p>
                                <p>Status: <span class="text-lime-400">ACTIVE (Anti-Remapping)</span></p>
                                <p>Steering events: <span id="brain-steers" class="text-white">0</span></p>
                            </div>
                            <div class="bg-black p-2 border border-purple-900 flex-1 overflow-y-auto" id="brain-log">
                                <!-- Brain decisions -->
                            </div>
                        </div>
                    </div>

                    <!-- REALITY TAB -->
                    <div id="tab-REALITY" class="hidden h-full flex flex-col font-mono text-xs text-orange-400 p-4 bg-gray-900 border border-orange-800 rounded">
                        <h3 class="text-orange-200 mb-2 border-b border-orange-800 pb-1">DISCRETE COORDINATE MATRIX</h3>
                        <div class="flex-1 bg-black border border-orange-900 p-2 overflow-y-auto" id="reality-grid-log">
                            <!-- Matrix coords -->
                        </div>
                    </div>

                    <!-- MUSEUM TAB -->
                    <div id="tab-MUSEUM" class="hidden h-full flex flex-col font-mono text-xs text-yellow-400 p-4 bg-gray-900 border border-yellow-800 rounded">
                        <h3 class="text-yellow-200 mb-2 border-b border-yellow-800 pb-1">ARTIFACT STORAGE (NOVEL CONFIGS)</h3>
                        <div class="flex-1 grid grid-cols-2 gap-2 overflow-y-auto pr-2" id="museum-gallery">
                            <!-- Artifact Cards -->
                        </div>
                    </div>

                    <!-- HYPER TAB -->
                    <div id="tab-HYPER" class="hidden h-full flex flex-col font-mono text-xs text-cyan-400 p-4 bg-gray-900 border border-cyan-800 rounded">
                        <h3 class="text-cyan-200 mb-2 border-b border-cyan-800 pb-1">BRANCHIAL SPACE / PHASE DIMENSIONALITY</h3>
                        <div class="flex-1 grid grid-cols-2 gap-4">
                            <div>
                                <p class="text-gray-400">Effective Dimension $d$</p>
                                <p class="text-2xl text-lime-400" id="hyper-dim">1.0000</p>
                            </div>
                            <div>
                                <p class="text-gray-400">Phase-Space Ergodicity</p>
                                <div class="w-full bg-gray-800 h-4 mt-1 rounded overflow-hidden">
                                    <div id="hyper-ergodicity" class="bg-magenta-500 h-full" style="width: 0%; background-color: #ff00ff"></div>
                                </div>
                            </div>
                            <div class="col-span-2 mt-2">
                                <p class="text-gray-400 mb-1">Poincaré Section (x, vx) Map</p>
                                <div id="hyper-scatter" class="w-full h-32 bg-black border border-cyan-900 relative overflow-hidden">
                                    <!-- Scatter points injected via JS -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ZETA TAB -->
                    <div id="tab-ZETA" class="hidden h-full flex flex-col font-mono text-xs text-magenta-400 p-4 bg-gray-900 border border-magenta-800 rounded">
                        <h3 class="text-magenta-200 mb-2 border-b border-magenta-800 pb-1">BLADE ALGORITHMIC HEURISTICS</h3>
                        <div class="grid grid-cols-2 gap-4 mb-2">
                            <div class="bg-black border border-magenta-900 p-2">
                                <p class="text-gray-400">High Zeta Found (&gt; 0.5)</p>
                                <p class="text-xl text-cyan-400" id="zeta-high">0</p>
                            </div>
                            <div class="bg-black border border-magenta-900 p-2">
                                <p class="text-gray-400">Low Zeta Found (&lt; 0.5)</p>
                                <p class="text-xl text-red-400" id="zeta-low">0</p>
                            </div>
                        </div>
                        <p class="mb-2 text-gray-400 mt-2">Quadratic Reality Tensor Matrix (Active weights)</p>
                        <div id="zeta-grid" class="grid grid-cols-8 grid-rows-8 flex-1 gap-1 min-h-[150px]">
                            <!-- Matrix generated by JS -->
                        </div>
                    </div>

                    <!-- LOG TAB -->
                    <div id="tab-LOG" class="hidden h-full flex flex-col font-mono text-xs text-lime-400 p-4 bg-black border border-lime-800 rounded overflow-hidden">
                        <h3 class="text-lime-200 mb-2 border-b border-lime-800 pb-1">CAUSAL GRAPH EVENT STREAM</h3>
                        <div id="log-container" class="flex-1 overflow-y-auto space-y-1 pr-2">
                            <span class="text-gray-600">Awaiting boundary interactions...</span>
                        </div>
                    </div>

                    <!-- RANK TAB (LEADERBOARD) -->
                    <div id="tab-RANK" class="hidden h-full flex flex-col font-mono text-xs text-emerald-400 p-4 bg-gray-900 border border-emerald-800 rounded overflow-hidden">
                        <h3 class="text-emerald-200 mb-2 border-b border-emerald-800 pb-1">NOVELTY LEADERBOARD (TOP ZETA CONFIGS)</h3>
                        <div class="flex justify-between text-[10px] text-gray-500 mb-2 px-1">
                            <span>RANK / BOUNCE</span>
                            <span>ZETA SCORE (ζ)</span>
                        </div>
                        <div id="leaderboard-container" class="flex-1 overflow-y-auto space-y-1 pr-2">
                            <span class="text-gray-600">Awaiting high-precision configurations...</span>
                        </div>
                    </div>

                    <!-- FALLBACK TAB -->
                    <div id="tab-OTHER" class="hidden h-full flex items-center justify-center font-mono text-gray-500 border border-gray-800 bg-gray-900 rounded">
                        <span id="other-tab-name"></span>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- ENGINE SCRIPT -->
    <script>
        // --- CONSTANTS & CONFIG ---
        const BOX_SIZE = 1;
        const CORNER_TOLERANCE = 0.05;
        const INITIAL_SPEED = 0.015;

        // --- HYPER-PRECISION ZETA GENERATOR ---
        // Generates a deterministic 101-decimal-place string based on grid variance
        function getHyperPrecisionZeta(baseNum, x, y) {
            let str = baseNum.toFixed(15);
            // Use X and Y coordinates as a geometric seed for the trailing digits
            let seed = Math.abs(Math.sin(x * 12.9898 + y * 78.233)) * 43758.5453;
            while(str.length < 103) { // 2 chars for "0." + 101 decimal digits = 103
                seed = Math.abs(Math.sin(seed) * 43758.5453);
                str += Math.floor((seed % 1) * 1e10).toString().padStart(10, '0');
            }
            return str.substring(0, 103);
        }

        // --- STATE ---
        let activeTab = 'LOG';
        let speed = 5;
        let trailLength = 800;
        
        let stats = {
            bounces: 0,
            cornerHits: 0,
            windingNumber: 0,
            lyapunovProxy: 0.0,
            freeConfigs: 180360
        };

        let agent = {
            x: 0.1,
            y: 0.2,
            vx: INITIAL_SPEED * 0.8,
            vy: INITIAL_SPEED * 1.2,
            theta: Math.atan2(0.2, 0.1),
            accumulatedTheta: 0,
            trail: []
        };
        let eventLog = [];

        // --- NEW SYSTEMS STATE ---
        let visitedGrid = new Map(); // Spatial hashing for avoidance
        let globalTick = 0; // Tracks absolute time for temporal rendering
        let artifacts = [];
        let leaderboard = []; // Stores top high-precision configs
        let zetaStats = { high: 0, low: 0, steers: 0 };
        let brainLog = [];
        let realityLog = [];

        // --- DOM ELEMENTS ---
        const canvas = document.getElementById('simCanvas');
        const ctx = canvas.getContext('2d');
        const speedInput = document.getElementById('speedInput');
        const speedLabel = document.getElementById('speedLabel');
        const trailInput = document.getElementById('trailInput');
        const trailLabel = document.getElementById('trailLabel');

        const statWinding = document.getElementById('statWinding');
        const statCorners = document.getElementById('statCorners');
        const statBounces = document.getElementById('statBounces');
        
        const logContainer = document.getElementById('log-container');
        const zetaGrid = document.getElementById('zeta-grid');
        const hyperDim = document.getElementById('hyper-dim');
        const hyperErgodicity = document.getElementById('hyper-ergodicity');

        // New DOM Elements
        const eyesCanvas = document.getElementById('eyesCanvas');
        const brainSteers = document.getElementById('brain-steers');
        const brainLogEl = document.getElementById('brain-log');
        const realityGridLog = document.getElementById('reality-grid-log');
        const museumGallery = document.getElementById('museum-gallery');
        const zetaHighEl = document.getElementById('zeta-high');
        const zetaLowEl = document.getElementById('zeta-low');
        const leaderboardContainer = document.getElementById('leaderboard-container');

        // --- SETUP TABS ---
        const tabs = ['EYES', 'BRAIN', 'REALITY', 'MUSEUM', 'HYPER', 'ZETA', 'LOG', 'RANK'];
        const tabHeaders = document.getElementById('tab-headers');

        function renderTabButtons() {
            tabHeaders.innerHTML = tabs.map(tab => `
                <button
                    onclick="switchTab('${tab}')"
                    class="px-3 py-2 flex-shrink-0 transition-colors ${
                        activeTab === tab 
                            ? 'bg-black text-white border-t-2 border-cyan-500' 
                            : 'text-gray-500 hover:text-gray-300 border-t-2 border-transparent'
                    }"
                >
                    ${tab}
                </button>
            `).join('');
        }

        function switchTab(tab) {
            activeTab = tab;
            renderTabButtons();
            
            // Hide all
            document.getElementById('tab-EYES').classList.add('hidden');
            document.getElementById('tab-BRAIN').classList.add('hidden');
            document.getElementById('tab-REALITY').classList.add('hidden');
            document.getElementById('tab-MUSEUM').classList.add('hidden');
            document.getElementById('tab-HYPER').classList.add('hidden');
            document.getElementById('tab-ZETA').classList.add('hidden');
            document.getElementById('tab-LOG').classList.add('hidden');
            document.getElementById('tab-RANK').classList.add('hidden');
            document.getElementById('tab-OTHER').classList.add('hidden');

            // Show active
            if (tabs.includes(tab)) {
                document.getElementById(`tab-${tab}`).classList.remove('hidden');
            } else {
                document.getElementById('tab-OTHER').classList.remove('hidden');
                document.getElementById('other-tab-name').innerText = `[ ${tab} MODULE CONNECTED ELSEWHERE ]`;
            }
        }

        // --- INITIALIZATION ---
        function init() {
            // Resize canvas to fit container
            function resize() {
                const rect = canvas.parentElement.getBoundingClientRect();
                canvas.width = rect.width;
                canvas.height = rect.height;
                if(eyesCanvas) {
                    const eyesRect = eyesCanvas.parentElement.getBoundingClientRect();
                    eyesCanvas.width = eyesRect.width;
                    eyesCanvas.height = eyesRect.height;
                }
            }
            window.addEventListener('resize', resize);
            resize();

            // Set up UI listeners
            speedInput.addEventListener('input', (e) => {
                speed = parseInt(e.target.value);
                speedLabel.innerText = `x${speed}`;
            });
            trailInput.addEventListener('input', (e) => {
                trailLength = parseInt(e.target.value);
                trailLabel.innerText = `${trailLength} steps`;
            });

            // Init Zeta Grid
            zetaGrid.innerHTML = Array.from({ length: 64 }).map(() => `<div class="rounded-sm transition-colors duration-100"></div>`).join('');

            // Init Hyper Scatter (Static mock map)
            const scatter = document.getElementById('hyper-scatter');
            scatter.innerHTML = Array.from({ length: 40 }).map((_, i) => `
                <div class="absolute w-1 h-1 bg-cyan-500 rounded-full opacity-50" 
                     style="left: ${50 + Math.sin(i * 0.5) * 40}%; top: ${50 + Math.cos(i * 0.6) * 40}%">
                </div>
            `).join('');

            renderTabButtons();
            switchTab(activeTab);
            requestAnimationFrame(loop);
        }

        // --- PHYSICS LOOP ---
        function updatePhysics() {
            let newEvents = [];
            let hitBoundary = false;

            // Sub-stepping for simulation speed (Sonic Drive)
            for (let step = 0; step < speed; step++) {
                let nextX = agent.x + agent.vx;
                let nextY = agent.y + agent.vy;
                let bouncedX = false;
                let bouncedY = false;
                let isCornerX = false;
                let isCornerY = false;

                // Specular Reflection Matrix (Square Boundary)
                if (nextX >= BOX_SIZE) { nextX = BOX_SIZE; agent.vx *= -1; bouncedX = true; }
                if (nextX <= -BOX_SIZE) { nextX = -BOX_SIZE; agent.vx *= -1; bouncedX = true; }
                if (nextY >= BOX_SIZE) { nextY = BOX_SIZE; agent.vy *= -1; bouncedY = true; }
                if (nextY <= -BOX_SIZE) { nextY = -BOX_SIZE; agent.vy *= -1; bouncedY = true; }

                if (bouncedX || bouncedY) {
                    hitBoundary = true;
                    stats.bounces++;
                    
                    // CORNER HIT DETECTION (Nils Bergland Logic)
                    isCornerX = Math.abs(nextX) >= BOX_SIZE - CORNER_TOLERANCE;
                    isCornerY = Math.abs(nextY) >= BOX_SIZE - CORNER_TOLERANCE;
                    
                    if (isCornerX && isCornerY) {
                        stats.cornerHits++;
                        newEvents.push(`[T=${stats.bounces}] PRECISION CORNER HIT DETECTED @ (${nextX.toFixed(2)}, ${nextY.toFixed(2)})`);
                    } else {
                        newEvents.push(`[T=${stats.bounces}] Vector Reflection @ (${nextX.toFixed(2)}, ${nextY.toFixed(2)})`);
                    }
                }

                // WINDING NUMBER CALCULATION
                let nextTheta = Math.atan2(nextY, nextX);
                let dTheta = nextTheta - agent.theta;
                // Handle wraparound
                if (dTheta > Math.PI) dTheta -= 2 * Math.PI;
                if (dTheta < -Math.PI) dTheta += 2 * Math.PI;
                
                agent.accumulatedTheta += dTheta;
                agent.theta = nextTheta;
                stats.windingNumber = agent.accumulatedTheta / (2 * Math.PI);

                // Update positions
                agent.x = nextX;
                agent.y = nextY;
                globalTick++; // Advance absolute time

                // Spatial Hashing & High-Precision Zeta Calculation (Avoid remapping)
                const gridSegments = 20; // 20x20 Macro Grid
                const gridX = Math.floor((agent.x + BOX_SIZE) * gridSegments);
                const gridY = Math.floor((agent.y + BOX_SIZE) * gridSegments);
                const gridKey = `${gridX},${gridY}`;
                
                const cellData = visitedGrid.get(gridKey) || { density: 0, lastVisit: 0 };
                visitedGrid.set(gridKey, { density: cellData.density + 1, lastVisit: globalTick });

                // 1. Calculate Macro Density Base (Drops as density increases)
                let baseZeta = Math.max(0.0, 1.0 - (cellData.density / 15.0));
                
                // 2. Add Micro-Variance
                let fracX = Math.abs((agent.x + BOX_SIZE) * gridSegments - gridX - 0.5); 
                let fracY = Math.abs((agent.y + BOX_SIZE) * gridSegments - gridY - 0.5);
                let microVariance = (0.5 - fracX) * (0.5 - fracY) * 0.39996; // Scales up to ~0.09999
                
                // Calculate numeric value for thresholds, and hyper-string for leaderboards
                let currentZetaNum = baseZeta > 0 ? Math.min(1.0, baseZeta + microVariance) : 0;
                let currentZetaStr = getHyperPrecisionZeta(currentZetaNum, agent.x, agent.y);
                
                if (currentZetaNum >= 0.5) {
                    zetaStats.high++;
                } else {
                    zetaStats.low++;
                    // BLADE AVOIDANCE LOGIC: We are remapping! Perturb trajectory.
                    zetaStats.steers++;
                    const currentAngle = Math.atan2(agent.vy, agent.vx);
                    const speedMag = Math.sqrt(agent.vx**2 + agent.vy**2);
                    // Perturb by small angle to seek new configs
                    const steerAngle = currentAngle + (Math.random() - 0.5) * 0.2; 
                    agent.vx = Math.cos(steerAngle) * speedMag;
                    agent.vy = Math.sin(steerAngle) * speedMag;
                    
                    if(Math.random() < 0.01) {
                        brainLog.push(`Steering away from [${gridX},${gridY}], Zeta: 0.${currentZetaStr.substring(2, 7)}...`);
                    }
                }

                if (Math.random() < 0.05) {
                    realityLog.push(`{ x: ${agent.x.toFixed(4)}, y: ${agent.y.toFixed(4)} }<br/><span class="text-[7px] text-cyan-500 break-all leading-none">ζ: ${currentZetaStr}</span>`);
                }

                // LEADERBOARD LOGIC: Record top high-precision novelty hits on boundary impact
                if ((bouncedX || bouncedY) && currentZetaNum > 0.6) {
                    leaderboard.push({
                        bounce: stats.bounces,
                        zetaStr: currentZetaStr,
                        x: agent.x,
                        y: agent.y
                    });
                    // String localeCompare works perfectly for 0.xxxxx strings of equal length
                    leaderboard.sort((a, b) => b.zetaStr.localeCompare(a.zetaStr));
                    if (leaderboard.length > 20) leaderboard.pop();
                }

                // ARTIFACT STORAGE (Museum) - Store exceptionally rare moments
                if ((bouncedX || bouncedY) && currentZetaNum > 0.95 && stats.bounces > 10 && Math.random() < 0.1) {
                    artifacts.unshift({
                        id: `ART-${Math.floor(Math.random()*10000)}`,
                        bounce: stats.bounces,
                        zetaStr: currentZetaStr,
                        desc: 'Novel Phase Space Config'
                    });
                }
                if ((bouncedX || bouncedY) && isCornerX && isCornerY) {
                    artifacts.unshift({
                        id: `ART-CRN-${Math.floor(Math.random()*10000)}`,
                        bounce: stats.bounces,
                        zetaStr: currentZetaStr,
                        desc: 'Precision Corner Singularity'
                    });
                }
                // Cap artifacts
                if (artifacts.length > 20) artifacts.pop();

                // Trail Memory (Smith Logic)
                agent.trail.push({ x: agent.x, y: agent.y, zeta: currentZetaNum });
                if (agent.trail.length > trailLength) {
                    agent.trail.shift();
                }
            }

            // --- UI UPDATES (Throttled/Conditional) ---
            
            // Log Tab update
            if (newEvents.length > 0) {
                eventLog = [...newEvents.reverse(), ...eventLog].slice(0, 50); // Keep last 50
                if (activeTab === 'LOG') {
                    logContainer.innerHTML = eventLog.map((log, i) => {
                        const opacityClass = `opacity-${Math.max(20, 100 - (i * 5))}`; // approximation
                        const highlight = log.includes('CORNER') ? 'text-magenta-400 font-bold bg-gray-900' : '';
                        return `<div class="${highlight}" style="opacity: ${1 - Math.min(i*0.05, 0.8)}">${log}</div>`;
                    }).join('');
                }
            }

            // Stats update
            if (hitBoundary || Math.random() < 0.05) {
                stats.lyapunovProxy = Math.abs(stats.windingNumber * 0.0142); // Mock proxy
                statWinding.innerText = stats.windingNumber.toFixed(3);
                statCorners.innerText = stats.cornerHits;
                statBounces.innerText = stats.bounces;

                if (activeTab === 'HYPER') {
                    hyperDim.innerText = (1.0 + Math.abs(stats.lyapunovProxy)).toFixed(4);
                    hyperErgodicity.style.width = `${Math.min(100, (stats.bounces / 5000) * 100)}%`;
                }
                
                if (activeTab === 'ZETA') {
                    zetaHighEl.innerText = zetaStats.high.toLocaleString();
                    zetaLowEl.innerText = zetaStats.low.toLocaleString();
                }

                if (activeTab === 'BRAIN') {
                    brainSteers.innerText = zetaStats.steers.toLocaleString();
                    if (brainLog.length > 10) brainLog = brainLog.slice(-10);
                    brainLogEl.innerHTML = brainLog.map(msg => `<div>&gt; ${msg}</div>`).join('');
                }

                if (activeTab === 'REALITY') {
                    if (realityLog.length > 10) realityLog = realityLog.slice(-10); // Reduced to fit massive numbers
                    realityGridLog.innerHTML = realityLog.map(msg => `<div class="mb-2 border-b border-orange-900/50 pb-1">${msg}</div>`).join('');
                }

                if (activeTab === 'MUSEUM') {
                    museumGallery.innerHTML = artifacts.map(art => `
                        <div class="border ${art.desc.includes('Corner') ? 'border-magenta-600 bg-magenta-900/20' : 'border-yellow-600 bg-yellow-900/20'} p-2 rounded flex flex-col">
                            <div class="text-white font-bold">${art.id}</div>
                            <div class="text-gray-400">Bounce: ${art.bounce}</div>
                            <div class="text-[7px] text-cyan-400 break-all leading-tight mt-1">ζ: ${art.zetaStr}</div>
                            <div class="text-[9px] mt-1 text-gray-300 mt-auto">${art.desc}</div>
                        </div>
                    `).join('');
                }

                if (activeTab === 'RANK') {
                    leaderboardContainer.innerHTML = leaderboard.map((entry, index) => `
                        <div class="flex flex-col border-b border-emerald-900/50 py-1 ${index === 0 ? 'bg-emerald-900/20 px-1' : ''}">
                            <div class="${index === 0 ? 'text-emerald-300 font-bold' : 'text-emerald-500'}">#${index + 1} &nbsp;[T=${entry.bounce}]</div>
                            <div class="font-bold text-[7.5px] text-emerald-400 break-all leading-tight">ζ: ${entry.zetaStr}</div>
                        </div>
                    `).join('');
                }
            }

            // Zeta Grid update
            if (activeTab === 'ZETA') {
                const cells = zetaGrid.children;
                for (let i = 0; i < 64; i++) {
                    const intensity = Math.abs(Math.sin((i % 8) * agent.x + Math.floor(i / 8) * agent.y));
                    cells[i].style.backgroundColor = `rgba(255, 0, 255, ${intensity * 0.8})`;
                }
            }
        }

        // --- RENDER LOOP ---
        function renderCanvas() {
            const w = canvas.width;
            const h = canvas.height;
            const cx = w / 2;
            const cy = h / 2;
            const scale = Math.min(w, h) / 2 * 0.9;

            // Clear background
            ctx.fillStyle = '#050505';
            ctx.fillRect(0, 0, w, h);

            // Draw Square Boundary
            ctx.strokeStyle = '#33ff00';
            ctx.lineWidth = 2;
            ctx.strokeRect(cx - scale, cy - scale, scale * 2, scale * 2);

            // Draw Corners (Highlight hit zones)
            ctx.fillStyle = 'rgba(255, 0, 128, 0.3)';
            const cSize = scale * CORNER_TOLERANCE * 2;
            ctx.fillRect(cx - scale - cSize/2, cy - scale - cSize/2, cSize, cSize); // TL
            ctx.fillRect(cx + scale - cSize/2, cy - scale - cSize/2, cSize, cSize); // TR
            ctx.fillRect(cx - scale - cSize/2, cy + scale - cSize/2, cSize, cSize); // BL
            ctx.fillRect(cx + scale - cSize/2, cy + scale - cSize/2, cSize, cSize); // BR

            // Draw Trail (Smith Memory) with ZETA COLOURS
            if (agent.trail.length > 1) {
                for (let i = 1; i < agent.trail.length; i++) {
                    ctx.beginPath();
                    ctx.moveTo(cx + agent.trail[i-1].x * scale, cy + agent.trail[i-1].y * scale);
                    ctx.lineTo(cx + agent.trail[i].x * scale, cy + agent.trail[i].y * scale);
                    
                    // Colour logic: Zeta 1.0 (Novel) -> Cyan (180). Zeta 0.0 (Old) -> Red/Magenta (300)
                    let z = agent.trail[i].zeta;
                    let hue = 300 - (z * 120); 
                    ctx.strokeStyle = `hsla(${hue}, 100%, 50%, 0.8)`;
                    ctx.lineWidth = 1.5;
                    ctx.stroke();
                }
            }

            // Draw Agent
            ctx.beginPath();
            ctx.arc(cx + agent.x * scale, cy + agent.y * scale, 4, 0, 2 * Math.PI);
            ctx.fillStyle = '#ffffff';
            ctx.fill();
            ctx.shadowBlur = 10;
            ctx.shadowColor = '#00ffff';
            ctx.closePath();
            ctx.shadowBlur = 0; // reset

            // Draw EYES Heatmap if active (Ruliad Temporal Block Style)
            if (activeTab === 'EYES' && eyesCanvas) {
                const eCtx = eyesCanvas.getContext('2d');
                eCtx.clearRect(0, 0, eyesCanvas.width, eyesCanvas.height);
                const ew = eyesCanvas.width;
                const eh = eyesCanvas.height;
                const gridSize = 40; // 40x40 grid mapping
                const cellW = ew / gridSize; 
                const cellH = eh / gridSize;
                
                visitedGrid.forEach((cell, key) => {
                    const [gx, gy] = key.split(',').map(Number);
                    const age = globalTick - cell.lastVisit;
                    
                    let color;
                    // 4 Colours encoding time/age of the block
                    if (age < 150) color = '#00ffff';      // 1. CYAN (Hot/Present)
                    else if (age < 600) color = '#ff00ff'; // 2. MAGENTA (Recent)
                    else if (age < 2400) color = '#ff8800';// 3. ORANGE (Older)
                    else color = '#220044';                // 4. DEEP PURPLE (Fossilized Structure)
                    
                    eCtx.fillStyle = color;
                    // Ruliad Style: -2px inset for distinct, discrete blocks
                    eCtx.fillRect((gx/gridSize)*ew + 1, (gy/gridSize)*eh + 1, cellW - 2, cellH - 2);
                });
            }
        }

        // --- MAIN GAME LOOP ---
        function loop() {
            updatePhysics();
            renderCanvas();
            requestAnimationFrame(loop);
        }

        // Boot
        window.onload = init;
    </script>
</body>
</html>