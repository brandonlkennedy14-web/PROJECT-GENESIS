<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Genesis // Inversion</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700;800&family=Inter:wght@400;700;900&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0a0a0a;
            color: #d1d5db;
        }
        .font-mono {
            font-family: 'JetBrains Mono', monospace;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #111; border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
    </style>
</head>
<body class="min-h-screen p-4 flex flex-col selection:bg-cyan-900">

    <!-- HEADER -->
    <header class="flex justify-between items-end border-b border-gray-700 pb-2 mb-4">
        <div>
            <h1 class="text-2xl font-black tracking-tighter text-white">PROJECT GENESIS <span class="text-cyan-500">//</span> INVERSION</h1>
            <h2 class="text-sm font-mono text-gray-500 uppercase tracking-widest mt-1">Sim3Colts Build :: Rulial Mechanics v2</h2>
        </div>
        <div class="text-right font-mono text-xs text-gray-500">
            STATUS: <span class="text-lime-500 animate-pulse">ONLINE</span><br/>
            ENGINE: RULIAD_KINEMATICS_X1
        </div>
    </header>

    <!-- MAIN GRID -->
    <div class="flex-1 grid grid-cols-1 lg:grid-cols-3 gap-6">
        
        <!-- LEFT PANE: CANVAS & CONTROLS -->
        <div class="lg:col-span-2 flex flex-col gap-4">
            
            <!-- SIMULATION VIEWPORT -->
            <div class="relative w-full h-[500px] bg-black border border-gray-800 rounded shadow-[0_0_30px_rgba(0,255,255,0.05)] overflow-hidden" id="canvas-container">
                <canvas id="simCanvas" class="absolute inset-0 w-full h-full"></canvas>
                <div class="absolute top-2 left-2 text-[10px] font-mono text-gray-500 select-none pointer-events-none">
                    GEOMETRY: SQUARE_STRICT<br/>
                    RAY_SPLIT: OFF
                </div>
            </div>

            <!-- SIMULATION CONTROLS -->
            <div class="grid grid-cols-2 gap-4 bg-gray-900 p-4 border border-gray-800 rounded font-mono text-xs">
                <div>
                    <label class="flex justify-between text-gray-400 mb-1">
                        <span>SONIC DRIVE (Time Δt)</span>
                        <span class="text-cyan-400" id="speedLabel">x5</span>
                    </label>
                    <input type="range" id="speedInput" min="1" max="50" value="5" class="w-full accent-cyan-500" />
                </div>
                <div>
                    <label class="flex justify-between text-gray-400 mb-1">
                        <span>SMITH TRAIL MEMORY</span>
                        <span class="text-magenta-400" id="trailLabel">800 steps</span>
                    </label>
                    <input type="range" id="trailInput" min="10" max="1000" value="800" class="w-full accent-magenta-500" />
                </div>
            </div>
        </div>

        <!-- RIGHT PANE: QUADRATIC REALITY MATRIX & OBSERVABLES -->
        <div class="flex flex-col gap-4 h-full">
            
            <!-- MACRO OBSERVABLES DASHBOARD -->
            <div class="bg-gray-900 p-4 border border-gray-800 rounded grid grid-cols-2 gap-y-4 gap-x-2 font-mono text-xs">
                <div class="col-span-2 border-b border-gray-800 pb-1 mb-1 text-gray-500 font-bold tracking-widest">
                    SYSTEM MACROSTATES
                </div>
                
                <div class="flex flex-col">
                    <span class="text-gray-500">AGG. WINDING ($W$)</span>
                    <span class="text-xl text-cyan-400 font-bold" id="statWinding">0.000</span>
                </div>
                
                <div class="flex flex-col">
                    <span class="text-gray-500">CORNER HITS (ε)</span>
                    <span class="text-xl text-magenta-400 font-bold" id="statCorners">0</span>
                </div>

                <div class="flex flex-col">
                    <span class="text-gray-500">BOUNDARY IMPACTS</span>
                    <span class="text-lg text-white" id="statBounces">0</span>
                </div>

                <div class="flex flex-col">
                    <span class="text-gray-500">FREE CONFIGS</span>
                    <span class="text-lg text-white" id="statConfigs">180,360</span>
                </div>
            </div>

            <!-- QUADRATIC REALITY MATRIX TABS -->
            <div class="flex-1 flex flex-col border border-gray-800 rounded overflow-hidden bg-black min-h-[300px]">
                <div class="flex bg-gray-900 border-b border-gray-800 text-[10px] font-mono overflow-x-auto" id="tab-headers">
                    <!-- Tab buttons generated by JS -->
                </div>
                
                <div class="flex-1 p-2 relative">
                    <!-- HYPER TAB -->
                    <div id="tab-HYPER" class="hidden h-full flex flex-col font-mono text-xs text-cyan-400 p-4 bg-gray-900 border border-cyan-800 rounded">
                        <h3 class="text-cyan-200 mb-2 border-b border-cyan-800 pb-1">BRANCHIAL SPACE / PHASE DIMENSIONALITY</h3>
                        <div class="flex-1 grid grid-cols-2 gap-4">
                            <div>
                                <p class="text-gray-400">Effective Dimension $d$</p>
                                <p class="text-2xl text-lime-400" id="hyper-dim">1.0000</p>
                            </div>
                            <div>
                                <p class="text-gray-400">Phase-Space Ergodicity</p>
                                <div class="w-full bg-gray-800 h-4 mt-1 rounded overflow-hidden">
                                    <div id="hyper-ergodicity" class="bg-magenta-500 h-full" style="width: 0%; background-color: #ff00ff"></div>
                                </div>
                            </div>
                            <div class="col-span-2 mt-2">
                                <p class="text-gray-400 mb-1">Poincaré Section (x, vx) Map</p>
                                <div id="hyper-scatter" class="w-full h-32 bg-black border border-cyan-900 relative overflow-hidden">
                                    <!-- Scatter points injected via JS -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ZETA TAB -->
                    <div id="tab-ZETA" class="hidden h-full flex flex-col font-mono text-xs text-magenta-400 p-4 bg-gray-900 border border-magenta-800 rounded">
                        <h3 class="text-magenta-200 mb-2 border-b border-magenta-800 pb-1">BLADE ALGORITHMIC HEURISTICS</h3>
                        <p class="mb-2 text-gray-400">Quadratic Reality Tensor Matrix (Active weights)</p>
                        <div id="zeta-grid" class="grid grid-cols-8 grid-rows-8 flex-1 gap-1">
                            <!-- Matrix generated by JS -->
                        </div>
                    </div>

                    <!-- LOG TAB -->
                    <div id="tab-LOG" class="hidden h-full flex flex-col font-mono text-xs text-lime-400 p-4 bg-black border border-lime-800 rounded overflow-hidden">
                        <h3 class="text-lime-200 mb-2 border-b border-lime-800 pb-1">CAUSAL GRAPH EVENT STREAM</h3>
                        <div id="log-container" class="flex-1 overflow-y-auto space-y-1 pr-2">
                            <span class="text-gray-600">Awaiting boundary interactions...</span>
                        </div>
                    </div>

                    <!-- FALLBACK TAB -->
                    <div id="tab-OTHER" class="hidden h-full flex items-center justify-center font-mono text-gray-500 border border-gray-800 bg-gray-900 rounded">
                        <span id="other-tab-name"></span>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- ENGINE SCRIPT -->
    <script>
        // --- CONSTANTS & CONFIG ---
        const BOX_SIZE = 1;
        const CORNER_TOLERANCE = 0.05;
        const INITIAL_SPEED = 0.015;

        // --- STATE ---
        let activeTab = 'LOG';
        let speed = 5;
        let trailLength = 800;
        
        let stats = {
            bounces: 0,
            cornerHits: 0,
            windingNumber: 0,
            lyapunovProxy: 0.0,
            freeConfigs: 180360
        };

        let agent = {
            x: 0.1,
            y: 0.2,
            vx: INITIAL_SPEED * 0.8,
            vy: INITIAL_SPEED * 1.2,
            theta: Math.atan2(0.2, 0.1),
            accumulatedTheta: 0,
            trail: []
        };
        let eventLog = [];

        // --- DOM ELEMENTS ---
        const canvas = document.getElementById('simCanvas');
        const ctx = canvas.getContext('2d');
        const speedInput = document.getElementById('speedInput');
        const speedLabel = document.getElementById('speedLabel');
        const trailInput = document.getElementById('trailInput');
        const trailLabel = document.getElementById('trailLabel');

        const statWinding = document.getElementById('statWinding');
        const statCorners = document.getElementById('statCorners');
        const statBounces = document.getElementById('statBounces');
        
        const logContainer = document.getElementById('log-container');
        const zetaGrid = document.getElementById('zeta-grid');
        const hyperDim = document.getElementById('hyper-dim');
        const hyperErgodicity = document.getElementById('hyper-ergodicity');

        // --- SETUP TABS ---
        const tabs = ['EYES', 'BRAIN', 'REALITY', 'MUSEUM', 'HYPER', 'ZETA', 'LOG'];
        const tabHeaders = document.getElementById('tab-headers');

        function renderTabButtons() {
            tabHeaders.innerHTML = tabs.map(tab => `
                <button
                    onclick="switchTab('${tab}')"
                    class="px-3 py-2 flex-shrink-0 transition-colors ${
                        activeTab === tab 
                            ? 'bg-black text-white border-t-2 border-cyan-500' 
                            : 'text-gray-500 hover:text-gray-300 border-t-2 border-transparent'
                    }"
                >
                    ${tab}
                </button>
            `).join('');
        }

        function switchTab(tab) {
            activeTab = tab;
            renderTabButtons();
            
            // Hide all
            document.getElementById('tab-HYPER').classList.add('hidden');
            document.getElementById('tab-ZETA').classList.add('hidden');
            document.getElementById('tab-LOG').classList.add('hidden');
            document.getElementById('tab-OTHER').classList.add('hidden');

            // Show active
            if (['HYPER', 'ZETA', 'LOG'].includes(tab)) {
                document.getElementById(`tab-${tab}`).classList.remove('hidden');
            } else {
                document.getElementById('tab-OTHER').classList.remove('hidden');
                document.getElementById('other-tab-name').innerText = `[ ${tab} MODULE CONNECTED ELSEWHERE ]`;
            }
        }

        // --- INITIALIZATION ---
        function init() {
            // Resize canvas to fit container
            function resize() {
                const rect = canvas.parentElement.getBoundingClientRect();
                canvas.width = rect.width;
                canvas.height = rect.height;
            }
            window.addEventListener('resize', resize);
            resize();

            // Set up UI listeners
            speedInput.addEventListener('input', (e) => {
                speed = parseInt(e.target.value);
                speedLabel.innerText = `x${speed}`;
            });
            trailInput.addEventListener('input', (e) => {
                trailLength = parseInt(e.target.value);
                trailLabel.innerText = `${trailLength} steps`;
            });

            // Init Zeta Grid
            zetaGrid.innerHTML = Array.from({ length: 64 }).map(() => `<div class="rounded-sm transition-colors duration-100"></div>`).join('');

            // Init Hyper Scatter (Static mock map)
            const scatter = document.getElementById('hyper-scatter');
            scatter.innerHTML = Array.from({ length: 40 }).map((_, i) => `
                <div class="absolute w-1 h-1 bg-cyan-500 rounded-full opacity-50" 
                     style="left: ${50 + Math.sin(i * 0.5) * 40}%; top: ${50 + Math.cos(i * 0.6) * 40}%">
                </div>
            `).join('');

            renderTabButtons();
            switchTab(activeTab);
            requestAnimationFrame(loop);
        }

        // --- PHYSICS LOOP ---
        function updatePhysics() {
            let newEvents = [];
            let hitBoundary = false;

            // Sub-stepping for simulation speed (Sonic Drive)
            for (let step = 0; step < speed; step++) {
                let nextX = agent.x + agent.vx;
                let nextY = agent.y + agent.vy;
                let bouncedX = false;
                let bouncedY = false;

                // Specular Reflection Matrix (Square Boundary)
                if (nextX >= BOX_SIZE) { nextX = BOX_SIZE; agent.vx *= -1; bouncedX = true; }
                if (nextX <= -BOX_SIZE) { nextX = -BOX_SIZE; agent.vx *= -1; bouncedX = true; }
                if (nextY >= BOX_SIZE) { nextY = BOX_SIZE; agent.vy *= -1; bouncedY = true; }
                if (nextY <= -BOX_SIZE) { nextY = -BOX_SIZE; agent.vy *= -1; bouncedY = true; }

                if (bouncedX || bouncedY) {
                    hitBoundary = true;
                    stats.bounces++;
                    
                    // CORNER HIT DETECTION (Nils Bergland Logic)
                    const isCornerX = Math.abs(nextX) >= BOX_SIZE - CORNER_TOLERANCE;
                    const isCornerY = Math.abs(nextY) >= BOX_SIZE - CORNER_TOLERANCE;
                    
                    if (isCornerX && isCornerY) {
                        stats.cornerHits++;
                        newEvents.push(`[T=${stats.bounces}] PRECISION CORNER HIT DETECTED @ (${nextX.toFixed(2)}, ${nextY.toFixed(2)})`);
                    } else {
                        newEvents.push(`[T=${stats.bounces}] Vector Reflection @ (${nextX.toFixed(2)}, ${nextY.toFixed(2)})`);
                    }
                }

                // WINDING NUMBER CALCULATION
                let nextTheta = Math.atan2(nextY, nextX);
                let dTheta = nextTheta - agent.theta;
                // Handle wraparound
                if (dTheta > Math.PI) dTheta -= 2 * Math.PI;
                if (dTheta < -Math.PI) dTheta += 2 * Math.PI;
                
                agent.accumulatedTheta += dTheta;
                agent.theta = nextTheta;
                stats.windingNumber = agent.accumulatedTheta / (2 * Math.PI);

                // Update positions
                agent.x = nextX;
                agent.y = nextY;

                // Trail Memory (Smith Logic)
                agent.trail.push({ x: agent.x, y: agent.y });
                if (agent.trail.length > trailLength) {
                    agent.trail.shift();
                }
            }

            // --- UI UPDATES (Throttled/Conditional) ---
            
            // Log Tab update
            if (newEvents.length > 0) {
                eventLog = [...newEvents.reverse(), ...eventLog].slice(0, 50); // Keep last 50
                if (activeTab === 'LOG') {
                    logContainer.innerHTML = eventLog.map((log, i) => {
                        const opacityClass = `opacity-${Math.max(20, 100 - (i * 5))}`; // approximation
                        const highlight = log.includes('CORNER') ? 'text-magenta-400 font-bold bg-gray-900' : '';
                        return `<div class="${highlight}" style="opacity: ${1 - Math.min(i*0.05, 0.8)}">${log}</div>`;
                    }).join('');
                }
            }

            // Stats update
            if (hitBoundary || Math.random() < 0.05) {
                stats.lyapunovProxy = Math.abs(stats.windingNumber * 0.0142); // Mock proxy
                statWinding.innerText = stats.windingNumber.toFixed(3);
                statCorners.innerText = stats.cornerHits;
                statBounces.innerText = stats.bounces;

                if (activeTab === 'HYPER') {
                    hyperDim.innerText = (1.0 + Math.abs(stats.lyapunovProxy)).toFixed(4);
                    hyperErgodicity.style.width = `${Math.min(100, (stats.bounces / 5000) * 100)}%`;
                }
            }

            // Zeta Grid update
            if (activeTab === 'ZETA') {
                const cells = zetaGrid.children;
                for (let i = 0; i < 64; i++) {
                    const intensity = Math.abs(Math.sin((i % 8) * agent.x + Math.floor(i / 8) * agent.y));
                    cells[i].style.backgroundColor = `rgba(255, 0, 255, ${intensity * 0.8})`;
                }
            }
        }

        // --- RENDER LOOP ---
        function renderCanvas() {
            const w = canvas.width;
            const h = canvas.height;
            const cx = w / 2;
            const cy = h / 2;
            const scale = Math.min(w, h) / 2 * 0.9;

            // Clear background
            ctx.fillStyle = '#050505';
            ctx.fillRect(0, 0, w, h);

            // Draw Square Boundary
            ctx.strokeStyle = '#33ff00';
            ctx.lineWidth = 2;
            ctx.strokeRect(cx - scale, cy - scale, scale * 2, scale * 2);

            // Draw Corners (Highlight hit zones)
            ctx.fillStyle = 'rgba(255, 0, 128, 0.3)';
            const cSize = scale * CORNER_TOLERANCE * 2;
            ctx.fillRect(cx - scale - cSize/2, cy - scale - cSize/2, cSize, cSize); // TL
            ctx.fillRect(cx + scale - cSize/2, cy - scale - cSize/2, cSize, cSize); // TR
            ctx.fillRect(cx - scale - cSize/2, cy + scale - cSize/2, cSize, cSize); // BL
            ctx.fillRect(cx + scale - cSize/2, cy + scale - cSize/2, cSize, cSize); // BR

            // Draw Trail (Smith Memory)
            if (agent.trail.length > 1) {
                ctx.beginPath();
                ctx.moveTo(cx + agent.trail[0].x * scale, cy + agent.trail[0].y * scale);
                for (let i = 1; i < agent.trail.length; i++) {
                    ctx.lineTo(cx + agent.trail[i].x * scale, cy + agent.trail[i].y * scale);
                }
                ctx.strokeStyle = 'rgba(0, 255, 255, 0.6)';
                ctx.lineWidth = 1;
                ctx.stroke();
            }

            // Draw Agent
            ctx.beginPath();
            ctx.arc(cx + agent.x * scale, cy + agent.y * scale, 4, 0, 2 * Math.PI);
            ctx.fillStyle = '#ffffff';
            ctx.fill();
            ctx.shadowBlur = 10;
            ctx.shadowColor = '#00ffff';
            ctx.closePath();
            ctx.shadowBlur = 0; // reset
        }

        // --- MAIN GAME LOOP ---
        function loop() {
            updatePhysics();
            renderCanvas();
            requestAnimationFrame(loop);
        }

        // Boot
        window.onload = init;
    </script>
</body>
</html>