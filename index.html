<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Genesis // Inversion</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SUPABASE CLIENT -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700;800&family=Inter:wght@400;700;900&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0a0a0a;
            color: #d1d5db;
        }
        .font-mono {
            font-family: 'JetBrains Mono', monospace;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #111; border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        /* Modal Blur */
        .glass-panel {
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(0, 255, 255, 0.3);
        }
    </style>
</head>
<body class="min-h-screen p-4 flex flex-col selection:bg-cyan-900 relative">

    <!-- HEADER -->
    <header class="flex justify-between items-end border-b border-gray-700 pb-2 mb-4">
        <div>
            <h1 class="text-2xl font-black tracking-tighter text-white">PROJECT GENESIS <span class="text-cyan-500">//</span> INVERSION</h1>
            <h2 class="text-sm font-mono text-gray-500 uppercase tracking-widest mt-1">Sim3Colts Build :: Multiway Swarm Architecture v4</h2>
        </div>
        <div class="flex items-center gap-6">
            <div class="text-right font-mono text-xs text-gray-500">
                STATUS: <span class="text-yellow-500 animate-pulse" id="save-status">CONNECTING SUPABASE...</span><br/>
                ENGINE: RULIAD_KINEMATICS_X7 (HIVE MIND)
            </div>
            <!-- BUY ME A COFFEE TIP JAR -->
            <a href="https://buymeacoffee.com/brandonkennedy" target="_blank" rel="noopener noreferrer" 
               class="bg-yellow-500/10 border border-yellow-500/50 text-yellow-500 hover:bg-yellow-500 hover:text-black transition-all px-4 py-2 rounded text-xs font-bold font-mono tracking-widest flex items-center gap-2">
                <span>☕</span> TIP JAR
            </a>
        </div>
    </header>

    <!-- MAIN GRID -->
    <div class="flex-1 grid grid-cols-1 lg:grid-cols-3 gap-6 relative">
        
        <!-- LEFT PANE: CANVAS & CONTROLS -->
        <div class="lg:col-span-2 flex flex-col gap-4">
            
            <!-- SIMULATION VIEWPORT -->
            <div class="relative w-full h-[500px] bg-black border border-gray-800 rounded shadow-[0_0_30px_rgba(0,255,255,0.05)] overflow-hidden" id="canvas-container">
                <canvas id="simCanvas" class="absolute inset-0 w-full h-full"></canvas>
                <div class="absolute top-2 left-2 text-[10px] font-mono text-gray-500 select-none pointer-events-none">
                    GEOMETRY: SQUARE_STRICT<br/>
                    MODE: 7-SWARM COLLECTIVE (14 AGENTS)<br/>
                    <span class="text-cyan-400">7x ALPHA (CONTROL)</span> | <span class="text-magenta-400">7x BETA (SHARED KNOWLEDGE)</span>
                </div>
            </div>

            <!-- SIMULATION CONTROLS -->
            <div class="grid grid-cols-2 gap-4 bg-gray-900 p-4 border border-gray-800 rounded font-mono text-xs">
                <div>
                    <label class="flex justify-between text-gray-400 mb-1">
                        <span>SONIC DRIVE (Time Δt)</span>
                        <span class="text-cyan-400" id="speedLabel">x5</span>
                    </label>
                    <input type="range" id="speedInput" min="1" max="50" value="5" class="w-full accent-cyan-500" />
                </div>
                <div>
                    <label class="flex justify-between text-gray-400 mb-1">
                        <span>SMITH TRAIL MEMORY (PER AGENT)</span>
                        <span class="text-magenta-400" id="trailLabel">200 steps</span>
                    </label>
                    <input type="range" id="trailInput" min="10" max="800" value="200" class="w-full accent-magenta-500" />
                </div>
            </div>
        </div>

        <!-- RIGHT PANE: QUADRATIC REALITY MATRIX & OBSERVABLES -->
        <div class="flex flex-col gap-4 h-full">
            
            <!-- MACRO OBSERVABLES DASHBOARD -->
            <div class="bg-gray-900 p-4 border border-gray-800 rounded grid grid-cols-2 gap-y-4 gap-x-2 font-mono text-xs relative overflow-hidden">
                <div class="col-span-2 border-b border-gray-800 pb-1 mb-1 text-gray-500 font-bold tracking-widest flex justify-between">
                    <span>SYSTEM MACROSTATES (COLLECTIVE)</span>
                    <span class="text-cyan-500">PEAK DIVERGENCE: <span id="statDivergence">0.000</span></span>
                </div>
                
                <div class="flex flex-col">
                    <span class="text-gray-500">AGG. WINDING ($W$)</span>
                    <span class="text-xl text-cyan-400 font-bold" id="statWinding">0.000</span>
                </div>
                
                <div class="flex flex-col">
                    <span class="text-gray-500">CORNER HITS (ε)</span>
                    <span class="text-xl text-magenta-400 font-bold" id="statCorners">0</span>
                </div>

                <div class="flex flex-col">
                    <span class="text-gray-500">SWARM IMPACTS</span>
                    <span class="text-lg text-white" id="statBounces">0</span>
                </div>

                <div class="flex flex-col">
                    <span class="text-gray-500">FREE CONFIGS</span>
                    <span class="text-lg text-white" id="statConfigs">180,360</span>
                </div>
            </div>

            <!-- QUADRATIC REALITY MATRIX TABS -->
            <div class="flex-1 flex flex-col border border-gray-800 rounded overflow-hidden bg-black min-h-[300px]">
                <div class="flex bg-gray-900 border-b border-gray-800 text-[10px] font-mono overflow-x-auto" id="tab-headers">
                    <!-- Tab buttons generated by JS -->
                </div>
                
                <div class="flex-1 p-2 relative">
                    <!-- SUPER BRAIN TAB (NEW) -->
                    <div id="tab-SUPER_BRAIN" class="hidden h-full flex flex-col font-mono text-xs text-blue-400 p-4 bg-gray-900 border border-blue-800 rounded">
                        <h3 class="text-blue-200 mb-2 border-b border-blue-800 pb-1">HIVE-MIND CROSS-REFERENCE</h3>
                        <div class="flex-1 overflow-y-auto space-y-3">
                            <div class="bg-black border border-blue-900 p-2">
                                <p class="text-gray-500 font-bold mb-1">COLLECTIVE INVARIANTS</p>
                                <div class="flex justify-between"><span class="text-gray-400">Energy (Velocity Mag):</span> <span class="text-lime-400 font-bold">ABSOLUTE CONSERVATION</span></div>
                                <div class="flex justify-between mt-1"><span class="text-gray-400">Phase Space Volume:</span> <span class="text-lime-400 font-bold">LIOUVILLE PRESERVED (Alpha)</span></div>
                                <div class="flex justify-between mt-1"><span class="text-gray-400">Corner Topology limits:</span> <span class="text-lime-400 font-bold">BOUNDED</span></div>
                            </div>
                            <div class="bg-black border border-blue-900 p-2">
                                <p class="text-gray-500 font-bold mb-1">SWARM VARIANTS (DIVERGENCE SPREAD)</p>
                                <div id="swarm-divergence-bars" class="space-y-1">
                                    <!-- Dynamic Bars -->
                                </div>
                            </div>
                            <div class="bg-black border border-blue-900 p-2">
                                <p class="text-gray-500 font-bold mb-1">COLLECTIVE VOID DETECTION</p>
                                <div class="flex justify-between"><span class="text-gray-400">Shared Caustic Radius:</span> <span id="super-void" class="text-cyan-400 font-bold">0.000</span></div>
                                <p class="text-[9px] text-gray-500 mt-1">If Swarm 1 enters a region, Swarms 2-7 inherit the structural knowledge and actively map around it.</p>
                            </div>
                        </div>
                    </div>

                    <!-- EYES TAB -->
                    <div id="tab-EYES" class="hidden h-full flex flex-col font-mono text-xs text-blue-400 p-4 bg-gray-900 border border-blue-800 rounded">
                        <h3 class="text-blue-200 mb-2 border-b border-blue-800 pb-1">SENSORY RECEPTORS (COMBINED HEATMAP)</h3>
                        <div class="flex-1 relative bg-black border border-blue-900 overflow-hidden">
                            <canvas id="eyesCanvas" class="absolute inset-0 w-full h-full opacity-80"></canvas>
                        </div>
                    </div>

                    <!-- STABILITY / ORBITS TAB -->
                    <div id="tab-STABILITY" class="hidden h-full flex flex-col font-mono text-xs text-indigo-400 p-4 bg-gray-900 border border-indigo-800 rounded">
                        <h3 class="text-indigo-200 mb-2 border-b border-indigo-800 pb-1">ORBITAL STABILITY METRICS</h3>
                        <div class="flex-1 overflow-y-auto space-y-2 pr-2" id="stability-log">
                            <div class="text-gray-500">Calculating periodic orbital variance across swarm...</div>
                        </div>
                    </div>

                    <!-- VOIDS TAB -->
                    <div id="tab-VOIDS" class="hidden h-full flex flex-col font-mono text-xs text-teal-400 p-4 bg-gray-900 border border-teal-800 rounded">
                        <h3 class="text-teal-200 mb-2 border-b border-teal-800 pb-1">CAUSTIC VOID TOPOLOGY</h3>
                        <div class="grid grid-cols-2 gap-2 mb-2">
                            <div class="bg-black border border-teal-900 p-2">
                                <p class="text-gray-500">Void Structure</p>
                                <p class="text-white" id="void-structure">Analyzing...</p>
                            </div>
                            <div class="bg-black border border-teal-900 p-2">
                                <p class="text-gray-500">Min. Radius (r)</p>
                                <p class="text-teal-400" id="void-radius">0.000</p>
                            </div>
                        </div>
                        <div class="text-gray-400 mt-2">Structured voids (circles) indicate a whispering gallery effect and conserved angular momentum. Random voids indicate chaotic multiway dispersion.</div>
                    </div>

                    <!-- MUSEUM TAB -->
                    <div id="tab-MUSEUM" class="hidden h-full flex flex-col font-mono text-xs text-yellow-400 p-4 bg-gray-900 border border-yellow-800 rounded">
                        <h3 class="text-yellow-200 mb-2 border-b border-yellow-800 pb-1">ARTIFACT STORAGE (CLICK TO RENDER)</h3>
                        <div class="flex-1 grid grid-cols-2 gap-2 overflow-y-auto pr-2" id="museum-gallery">
                            <!-- Artifact Cards -->
                        </div>
                    </div>

                    <!-- HYPER TAB -->
                    <div id="tab-HYPER" class="hidden h-full flex flex-col font-mono text-xs text-cyan-400 p-4 bg-gray-900 border border-cyan-800 rounded">
                        <h3 class="text-cyan-200 mb-2 border-b border-cyan-800 pb-1">BRANCHIAL SPACE / PHASE DIMENSIONALITY</h3>
                        <div class="flex-1 grid grid-cols-2 gap-4">
                            <div>
                                <p class="text-gray-400">Effective Dimension $d$</p>
                                <p class="text-2xl text-lime-400" id="hyper-dim">1.0000</p>
                            </div>
                            <div>
                                <p class="text-gray-400">Phase-Space Ergodicity</p>
                                <div class="w-full bg-gray-800 h-4 mt-1 rounded overflow-hidden">
                                    <div id="hyper-ergodicity" class="bg-magenta-500 h-full" style="width: 0%; background-color: #ff00ff"></div>
                                </div>
                            </div>
                            <div class="col-span-2 mt-2">
                                <p class="text-gray-400 mb-1">Poincaré Section (x, θ) Map</p>
                                <div class="w-full h-32 bg-black border border-cyan-900 relative overflow-hidden">
                                    <canvas id="hyperCanvas" class="absolute inset-0 w-full h-full opacity-90"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ZETA TAB -->
                    <div id="tab-ZETA" class="hidden h-full flex flex-col font-mono text-xs text-magenta-400 p-4 bg-gray-900 border border-magenta-800 rounded">
                        <h3 class="text-magenta-200 mb-2 border-b border-magenta-800 pb-1">BLADE ALGORITHMIC HEURISTICS</h3>
                        <div class="grid grid-cols-2 gap-4 mb-2">
                            <div class="bg-black border border-magenta-900 p-2">
                                <p class="text-gray-400">High Zeta Found (&gt; 0.5)</p>
                                <p class="text-xl text-cyan-400" id="zeta-high">0</p>
                            </div>
                            <div class="bg-black border border-magenta-900 p-2">
                                <p class="text-gray-400">Low Zeta Found (&lt; 0.5)</p>
                                <p class="text-xl text-red-400" id="zeta-low">0</p>
                            </div>
                        </div>
                        <p class="mb-2 text-gray-400 mt-2">Quadratic Reality Tensor Matrix (Swarm 1 View)</p>
                        <div class="flex-1 relative bg-black border border-magenta-900 min-h-[150px]">
                            <canvas id="zetaCanvas" class="absolute inset-0 w-full h-full opacity-90"></canvas>
                        </div>
                    </div>

                    <!-- RANK TAB (GLOBAL LEADERBOARD) -->
                    <div id="tab-RANK" class="hidden h-full flex flex-col font-mono text-xs text-emerald-400 p-4 bg-gray-900 border border-emerald-800 rounded overflow-hidden">
                        <h3 class="text-emerald-200 mb-2 border-b border-emerald-800 pb-1">CROSS-REF GLOBAL LEADERBOARD</h3>
                        <div class="flex justify-between text-[10px] text-gray-500 mb-2 px-1">
                            <span>RANK / TYPE / UID</span>
                            <span>ZETA SCORE (ζ)</span>
                        </div>
                        <div id="leaderboard-container" class="flex-1 overflow-y-auto space-y-1 pr-2">
                            <span class="text-gray-600">Syncing multiway data stream...</span>
                        </div>
                    </div>

                    <!-- FALLBACK TAB -->
                    <div id="tab-OTHER" class="hidden h-full flex items-center justify-center font-mono text-gray-500 border border-gray-800 bg-gray-900 rounded text-center p-4">
                        <span id="other-tab-name"></span>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- ARTIFACT RENDER MODAL -->
    <div id="artifactModal" class="fixed inset-0 z-50 hidden items-center justify-center p-8 bg-black/80 backdrop-blur-sm">
        <div class="glass-panel w-full max-w-4xl h-[80vh] flex flex-col rounded shadow-2xl overflow-hidden">
            <div class="bg-gray-900 border-b border-cyan-800 p-4 flex justify-between items-center">
                <h2 class="text-cyan-400 font-mono font-bold tracking-widest" id="modal-title">ARTIFACT RENDER</h2>
                <button onclick="closeModal()" class="text-red-500 hover:text-red-400 font-mono text-xl font-bold px-2">&times;</button>
            </div>
            <div class="flex-1 grid grid-cols-2 p-4 gap-4 bg-black relative">
                <div class="flex flex-col border border-gray-800 rounded bg-gray-900 relative overflow-hidden">
                    <div class="absolute top-0 left-0 right-0 bg-black/80 border-b border-gray-800 p-2 z-10 text-center font-mono text-xs text-gray-400">
                        2D TRAJECTORY SPACE (SWARM OVERLAY)
                    </div>
                    <canvas id="modalTrajCanvas" class="w-full h-full"></canvas>
                </div>
                <div class="flex flex-col border border-gray-800 rounded bg-gray-900 relative overflow-hidden">
                    <div class="absolute top-0 left-0 right-0 bg-black/80 border-b border-gray-800 p-2 z-10 text-center font-mono text-xs text-gray-400">
                        RULIAD BLOCK PATTERN
                    </div>
                    <canvas id="modalRuliadCanvas" class="w-full h-full"></canvas>
                </div>
            </div>
            <div class="bg-gray-900 p-4 border-t border-cyan-800 text-xs font-mono text-gray-400" id="modal-desc">
                Data description.
            </div>
        </div>
    </div>

    <!-- ENGINE SCRIPT & CLOUD SYNC -->
    <script>
        // --- CONSTANTS & CONFIG ---
        const BOX_SIZE = 1;
        const CORNER_TOLERANCE = 0.05;
        const INITIAL_SPEED = 0.015;
        const NUM_SWARMS = 7;

        // --- SUPABASE CLOUD STATE ---
        let supabaseClient;
        let currentUser;
        let isLoopRunning = false;
        let isSaving = false;
        let lastSaveBounce = 0;

        // --- HYPER-PRECISION ZETA GENERATOR (UPGRADED LCG) ---
        function getHyperPrecisionZeta(baseNum, x, y) {
            let str = baseNum.toFixed(15);
            let seed = Math.abs(Math.floor(x * 10000000) ^ Math.floor(y * 10000000));
            if (seed === 0) seed = 123456789; 
            
            while(str.length < 103) { 
                seed = (seed * 9301 + 49297) % 233280; 
                let fraction = seed / 233280;
                str += Math.floor(fraction * 1e10).toString().padStart(10, '0');
            }
            return str.substring(0, 103);
        }

        // --- MULTIWAY SWARM STATE ---
        let activeTab = 'SUPER_BRAIN';
        let speed = 5;
        let trailLength = 200; // Lower default to handle 14 agents
        
        let stats = { bounces: 0, cornerHits: 0, windingNumber: 0, lyapunovProxy: 0.0, freeConfigs: 180360 };
        let zetaStats = { high: 0, low: 0, steers: 0 };
        
        // Initialize 7 Swarm Groups
        let fleet = Array.from({ length: NUM_SWARMS }, (_, i) => {
            // Distribute start positions to explore different configs
            const angle = (i / NUM_SWARMS) * Math.PI * 2;
            const r = 0.3;
            const sx = Math.cos(angle) * r;
            const sy = Math.sin(angle) * r;
            const stheta = angle + Math.PI/4; 
            const vx = Math.cos(stheta) * INITIAL_SPEED;
            const vy = Math.sin(stheta) * INITIAL_SPEED;

            return {
                id: i,
                alpha: { x: sx, y: sy, vx: vx, vy: vy, theta: stheta, accumulatedTheta: 0, trail: [] },
                beta:  { x: sx, y: sy, vx: vx, vy: vy, theta: stheta, accumulatedTheta: 0, trail: [] },
                divergence: 0,
                bounces: 0
            };
        });

        let eventLog = [];
        let visitedGrid = new Map(); // Shared Knowledge Grid
        let hyperGrid = new Map(); 
        let globalTick = 0; 
        let artifacts = [];
        let globalLeaderboard = []; 
        
        // Voids & Stability Tracking
        let stabilityHistory = [];
        let minOrbitRadius = Infinity;

        // --- DOM ELEMENTS ---
        const canvas = document.getElementById('simCanvas');
        const ctx = canvas.getContext('2d');
        const speedInput = document.getElementById('speedInput');
        const speedLabel = document.getElementById('speedLabel');
        const trailInput = document.getElementById('trailInput');
        const trailLabel = document.getElementById('trailLabel');

        const statWinding = document.getElementById('statWinding');
        const statCorners = document.getElementById('statCorners');
        const statBounces = document.getElementById('statBounces');
        const statDivergence = document.getElementById('statDivergence');
        
        const eyesCanvas = document.getElementById('eyesCanvas');
        const hyperCanvas = document.getElementById('hyperCanvas');
        const zetaCanvas = document.getElementById('zetaCanvas');
        const museumGallery = document.getElementById('museum-gallery');
        const leaderboardContainer = document.getElementById('leaderboard-container');
        const saveStatusEl = document.getElementById('save-status');
        
        const stabilityLog = document.getElementById('stability-log');
        const voidStructure = document.getElementById('void-structure');
        const voidRadius = document.getElementById('void-radius');
        const hyperDim = document.getElementById('hyper-dim');
        const hyperErgodicity = document.getElementById('hyper-ergodicity');
        const zetaHighEl = document.getElementById('zeta-high');
        const zetaLowEl = document.getElementById('zeta-low');
        
        const superVoidEl = document.getElementById('super-void');
        const swarmDivergenceBars = document.getElementById('swarm-divergence-bars');

        // Modal Elements
        const artifactModal = document.getElementById('artifactModal');
        const modalTitle = document.getElementById('modal-title');
        const modalDesc = document.getElementById('modal-desc');
        const modalTrajCanvas = document.getElementById('modalTrajCanvas');
        const modalRuliadCanvas = document.getElementById('modalRuliadCanvas');

        // --- SETUP TABS ---
        const tabs = ['SUPER_BRAIN', 'EYES', 'STABILITY', 'VOIDS', 'MUSEUM', 'HYPER', 'ZETA', 'RANK'];
        const tabHeaders = document.getElementById('tab-headers');

        function renderTabButtons() {
            tabHeaders.innerHTML = tabs.map(tab => `
                <button
                    onclick="window.switchTab('${tab}')"
                    class="px-3 py-2 flex-shrink-0 transition-colors ${
                        activeTab === tab 
                            ? 'bg-black text-white border-t-2 border-cyan-500' 
                            : 'text-gray-500 hover:text-gray-300 border-t-2 border-transparent'
                    }"
                >
                    ${tab}
                </button>
            `).join('');
        }

        window.switchTab = function(tab) {
            activeTab = tab;
            renderTabButtons();
            
            [...tabs, 'OTHER'].forEach(t => {
                const el = document.getElementById(`tab-${t}`);
                if (el) el.classList.add('hidden');
            });

            if (tabs.includes(tab)) {
                document.getElementById(`tab-${tab}`).classList.remove('hidden');
                if (tab === 'RANK') renderLeaderboardUI();
                setTimeout(() => window.dispatchEvent(new Event('resize')), 10);
            } else {
                document.getElementById('tab-OTHER').classList.remove('hidden');
                document.getElementById('other-tab-name').innerText = `[ ${tab} MODULE ARCHIVED ]\nConsolidated into Dual-Sim layout.`;
            }
        };

        // --- CLOUD SYNC LOGIC (SUPABASE) ---
        async function loadStateFromCloud() {
            if (!supabaseClient || !currentUser) return;
            try {
                const { data } = await supabaseClient.from('saves').select('state_data').eq('user_id', currentUser.uid).single();
                if (data && data.state_data) {
                    const saved = data.state_data;
                    stats = saved.stats || stats;
                    zetaStats = saved.zetaStats || zetaStats;
                    
                    if (saved.fleet && saved.fleet.length === NUM_SWARMS) {
                        fleet = saved.fleet.map((g, i) => ({
                            id: i,
                            alpha: { ...fleet[i].alpha, ...g.alpha, trail: [] },
                            beta: { ...fleet[i].beta, ...g.beta, trail: [] },
                            divergence: g.divergence || 0,
                            bounces: g.bounces || 0
                        }));
                    }
                    
                    globalTick = saved.globalTick || 0;
                    artifacts = saved.artifacts || [];
                    if (saved.visitedGrid) try { visitedGrid = new Map(JSON.parse(saved.visitedGrid)); } catch(e) {}
                    if (saved.hyperGrid) try { hyperGrid = new Map(JSON.parse(saved.hyperGrid)); } catch(e) {}
                    lastSaveBounce = stats.bounces;
                }
            } catch (e) { console.error("Private cloud load failed", e); }
        }

        async function setupGlobalLeaderboardListener() {
            if (!supabaseClient) return;
            const { data } = await supabaseClient.from('global_state').select('leaderboard_data').eq('id', 'main_leaderboard').single();
            if (data && data.leaderboard_data) {
                globalLeaderboard = data.leaderboard_data.entries || [];
                if (activeTab === 'RANK') renderLeaderboardUI();
            }
            supabaseClient.channel('public:global_state').on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'global_state', filter: 'id=eq.main_leaderboard' }, payload => {
                if (payload.new && payload.new.leaderboard_data) {
                    globalLeaderboard = payload.new.leaderboard_data.entries || [];
                    if (activeTab === 'RANK') renderLeaderboardUI();
                }
            }).subscribe();
        }

        async function saveStateToCloud() {
            if (!supabaseClient || !currentUser || isSaving) return;
            isSaving = true;
            saveStatusEl.innerText = 'SYNCING REALITY...';
            saveStatusEl.classList.replace('text-lime-500', 'text-yellow-500');
            try {
                const state = {
                    stats, zetaStats,
                    fleet: fleet.map(g => ({
                        alpha: { x: g.alpha.x, y: g.alpha.y, vx: g.alpha.vx, vy: g.alpha.vy, theta: g.alpha.theta },
                        beta: { x: g.beta.x, y: g.beta.y, vx: g.beta.vx, vy: g.beta.vy, theta: g.beta.theta },
                        divergence: g.divergence, bounces: g.bounces
                    })),
                    globalTick, artifacts,
                    visitedGrid: JSON.stringify(Array.from(visitedGrid.entries())),
                    hyperGrid: JSON.stringify(Array.from(hyperGrid.entries()))
                };
                await supabaseClient.from('saves').upsert({ user_id: currentUser.uid, state_data: state });
                saveStatusEl.innerText = 'MULTIWAY CLOUD SYNCED';
                saveStatusEl.classList.replace('text-yellow-500', 'text-lime-500');
            } catch (e) {
                saveStatusEl.innerText = 'SYNC ERROR';
                saveStatusEl.classList.replace('text-yellow-500', 'text-red-500');
            }
            isSaving = false;
        }

        // --- UI RENDER HELPERS ---
        function renderLeaderboardUI() {
            if (globalLeaderboard.length === 0) {
                leaderboardContainer.innerHTML = `<span class="text-gray-600">No public configurations cataloged yet.</span>`;
                return;
            }
            leaderboardContainer.innerHTML = globalLeaderboard.map((entry, index) => {
                const isMe = currentUser && entry.uid === currentUser.uid;
                const displayUid = entry.uid.split('-')[0] + '...';
                const color = entry.type === 'ALPHA' ? 'text-cyan-400' : 'text-magenta-400';
                return `
                <div class="flex flex-col border-b border-emerald-900/50 py-1 ${index === 0 ? 'bg-emerald-900/20 px-1' : ''} ${isMe ? 'border-l-2 border-l-lime-400 pl-1 bg-emerald-900/10' : ''}">
                    <div class="flex justify-between w-full items-center">
                        <div class="${index === 0 ? 'text-emerald-300 font-bold' : 'text-emerald-500'}">#${index + 1} <span class="${color} text-[8px] ml-1">[SWRM-${entry.swarmId} ${entry.type}]</span></div>
                        <div class="text-[9px] text-gray-500 font-bold">${isMe ? '<span class="text-lime-400">YOU</span>' : displayUid}</div>
                    </div>
                    <div class="font-bold text-[7.5px] text-emerald-400 break-all leading-tight mt-1">ζ: ${entry.zetaStr}</div>
                </div>
            `}).join('');
        }

        function openArtifactModal(id) {
            const art = artifacts.find(a => a.id === id);
            if (!art) return;
            
            modalTitle.innerText = `ARTIFACT // ${art.id}`;
            modalDesc.innerHTML = `<span class="text-cyan-400">Triggering Swarm:</span> SWRM ${art.triggerSwarm}<br/><span class="text-cyan-400">Alpha Zeta:</span> ${art.zetaStrAlpha}<br/><span class="text-magenta-400">Beta Zeta:</span> ${art.zetaStrBeta}<br/>Discovered at T=${art.bounce}. ${art.desc}`;
            artifactModal.classList.remove('hidden');
            artifactModal.classList.add('flex');

            const tCtx = modalTrajCanvas.getContext('2d');
            const rCtx = modalRuliadCanvas.getContext('2d');
            const w = modalTrajCanvas.width = modalTrajCanvas.parentElement.clientWidth;
            const h = modalTrajCanvas.height = modalTrajCanvas.parentElement.clientHeight - 30; 
            modalRuliadCanvas.width = w; modalRuliadCanvas.height = h;

            tCtx.fillStyle = '#050505'; tCtx.fillRect(0, 0, w, h);
            const cx = w/2; const cy = h/2; const scale = Math.min(w,h)/2 * 0.9;
            
            tCtx.strokeStyle = '#33ff00'; tCtx.lineWidth = 1; tCtx.strokeRect(cx - scale, cy - scale, scale*2, scale*2);
            
            if (art.trailAlpha && art.trailAlpha.length > 1) {
                tCtx.beginPath(); tCtx.moveTo(cx + art.trailAlpha[0].x * scale, cy + art.trailAlpha[0].y * scale);
                for (let i=1; i<art.trailAlpha.length; i++) tCtx.lineTo(cx + art.trailAlpha[i].x * scale, cy + art.trailAlpha[i].y * scale);
                tCtx.strokeStyle = 'rgba(0, 255, 255, 0.7)'; tCtx.stroke();
            }
            if (art.trailBeta && art.trailBeta.length > 1) {
                tCtx.beginPath(); tCtx.moveTo(cx + art.trailBeta[0].x * scale, cy + art.trailBeta[0].y * scale);
                for (let i=1; i<art.trailBeta.length; i++) tCtx.lineTo(cx + art.trailBeta[i].x * scale, cy + art.trailBeta[i].y * scale);
                tCtx.strokeStyle = 'rgba(255, 0, 255, 0.7)'; tCtx.stroke();
            }

            rCtx.fillStyle = '#000'; rCtx.fillRect(0, 0, w, h);
            if (art.gridSnapshot) {
                const gridSize = 40; const cellW = w/gridSize; const cellH = h/gridSize;
                art.gridSnapshot.forEach((cell, key) => {
                    const [gx, gy] = key.split(',').map(Number);
                    const age = art.tick - cell.lastVisit;
                    rCtx.fillStyle = getRuliadColor(age);
                    rCtx.fillRect((gx/gridSize)*w+1, (gy/gridSize)*h+1, cellW-2, cellH-2);
                });
            }
        }

        window.closeModal = function() {
            artifactModal.classList.add('hidden');
            artifactModal.classList.remove('flex');
        }

        // --- INITIALIZATION ---
        function setupUI() {
            function resize() {
                const rect = canvas.parentElement.getBoundingClientRect();
                canvas.width = rect.width; canvas.height = rect.height;
                [eyesCanvas, hyperCanvas, zetaCanvas].forEach(c => {
                    if(c && c.parentElement) {
                        const r = c.parentElement.getBoundingClientRect();
                        if (r.width > 0 && r.height > 0) { c.width = r.width; c.height = r.height; }
                    }
                });
            }
            window.addEventListener('resize', resize);
            resize();

            speedInput.addEventListener('input', (e) => { speed = parseInt(e.target.value); speedLabel.innerText = `x${speed}`; });
            trailInput.addEventListener('input', (e) => { trailLength = parseInt(e.target.value); trailLabel.innerText = `${trailLength} steps`; });
            
            renderTabButtons();
            window.switchTab(activeTab);
        }

        // --- CORE PHYSICS ENGINE (MULTIWAY SWARM) ---
        function moveAgent(agent, isBetaObserver) {
            let nextX = agent.x + agent.vx;
            let nextY = agent.y + agent.vy;
            let bounced = false;
            let cornerHit = false;

            // EXACT PHASE SPACE FOLDING
            if (nextX > BOX_SIZE) { nextX = BOX_SIZE - (nextX - BOX_SIZE); agent.vx *= -1; bounced = true; } 
            else if (nextX < -BOX_SIZE) { nextX = -BOX_SIZE + (-BOX_SIZE - nextX); agent.vx *= -1; bounced = true; }
            if (nextY > BOX_SIZE) { nextY = BOX_SIZE - (nextY - BOX_SIZE); agent.vy *= -1; bounced = true; } 
            else if (nextY < -BOX_SIZE) { nextY = -BOX_SIZE + (-BOX_SIZE - nextY); agent.vy *= -1; bounced = true; }

            if (bounced) {
                const isCornerX = Math.abs(nextX) >= BOX_SIZE - CORNER_TOLERANCE;
                const isCornerY = Math.abs(nextY) >= BOX_SIZE - CORNER_TOLERANCE;
                cornerHit = isCornerX && isCornerY;
            }

            const radius = Math.sqrt(nextX*nextX + nextY*nextY);
            if (radius < minOrbitRadius) minOrbitRadius = radius;

            agent.x = nextX;
            agent.y = nextY;

            // HIVE-MIND SHARED KNOWLEDGE GRID
            const gridSegments = 20; 
            const gridX = Math.floor((agent.x + BOX_SIZE) * gridSegments);
            const gridY = Math.floor((agent.y + BOX_SIZE) * gridSegments);
            const gridKey = `${gridX},${gridY}`;
            
            const cellData = visitedGrid.get(gridKey) || { density: 0, lastVisit: 0 };
            visitedGrid.set(gridKey, { density: cellData.density + 1, lastVisit: globalTick });

            let baseZeta = Math.max(0.0, 1.0 - (cellData.density / 15.0));
            let fracX = Math.abs((agent.x + BOX_SIZE) * gridSegments - gridX - 0.5); 
            let fracY = Math.abs((agent.y + BOX_SIZE) * gridSegments - gridY - 0.5);
            let microVariance = (0.5 - fracX) * (0.5 - fracY) * 0.39996; 
            
            let currentZetaNum = baseZeta > 0 ? Math.min(1.0, baseZeta + microVariance) : 0;
            let currentZetaStr = getHyperPrecisionZeta(currentZetaNum, agent.x, agent.y);

            if (currentZetaNum >= 0.5) zetaStats.high++;
            else zetaStats.low++;

            // TRUE POINCARE SECTION
            if (bounced) {
                let nextTheta = agent.theta;
                if (nextX !== 0 || nextY !== 0) nextTheta = Math.atan2(nextY, nextX);
                
                let dTheta = nextTheta - agent.theta;
                if (dTheta > Math.PI) dTheta -= 2 * Math.PI;
                if (dTheta < -Math.PI) dTheta += 2 * Math.PI;
                
                agent.accumulatedTheta += dTheta;
                agent.theta = nextTheta;

                const hyperX = Math.floor((agent.x + BOX_SIZE) * 20); 
                const hyperTheta = Math.floor(((agent.theta + Math.PI) / (2 * Math.PI)) * 40); 
                const hyperKey = `${hyperX},${hyperTheta}`;
                const hyperCellData = hyperGrid.get(hyperKey) || { density: 0, lastVisit: 0 };
                hyperGrid.set(hyperKey, { density: hyperCellData.density + 1, lastVisit: globalTick });
            }

            // BLADE HEURISTIC (Steer away from shared knowledge map)
            if (isBetaObserver && currentZetaNum < 0.5) {
                const currentAngle = Math.atan2(agent.vy, agent.vx);
                const speedMag = Math.sqrt(agent.vx**2 + agent.vy**2);
                const steerAngle = currentAngle + (Math.random() - 0.5) * 0.1; 
                agent.vx = Math.cos(steerAngle) * speedMag;
                agent.vy = Math.sin(steerAngle) * speedMag;
            }

            agent.trail.push({ x: agent.x, y: agent.y });
            if (agent.trail.length > trailLength) agent.trail.shift();

            return { bounced, cornerHit, zetaNum: currentZetaNum, zetaStr: currentZetaStr };
        }

        function updatePhysics() {
            let swarmHitBoundary = false;
            let triggerArtifact = false;
            let artifactGroup = null;
            let maxDivergence = 0;

            for (let step = 0; step < speed; step++) {
                globalTick++; 
                
                fleet.forEach(group => {
                    const alphaRes = moveAgent(group.alpha, false);
                    const betaRes = moveAgent(group.beta, true);

                    if (alphaRes.bounced || betaRes.bounced) {
                        swarmHitBoundary = true;
                        group.bounces++;
                        stats.bounces++; 
                        
                        if (alphaRes.cornerHit || betaRes.cornerHit) stats.cornerHits++;

                        stabilityHistory.push(stats.bounces);
                        if (stabilityHistory.length > 5) stabilityHistory.shift();

                        if (!triggerArtifact && (alphaRes.zetaNum > 0.95 || betaRes.zetaNum > 0.95)) {
                            triggerArtifact = true;
                            artifactGroup = { 
                                id: group.id, 
                                zetaStrAlpha: alphaRes.zetaStr, 
                                zetaStrBeta: betaRes.zetaStr,
                                trailAlpha: [...group.alpha.trail],
                                trailBeta: [...group.beta.trail]
                            };
                        }

                        // Evaluate Multiway Leaderboard for this specific swarm agent
                        if (supabaseClient) {
                            [ {r: alphaRes, t: 'ALPHA'}, {r: betaRes, t: 'BETA'} ].forEach(evalAgent => {
                                if (evalAgent.r.zetaNum > 0.6) {
                                    let isGlobalTop = false;
                                    if (globalLeaderboard.length < 20) {
                                        isGlobalTop = true;
                                    } else {
                                        const lowest = globalLeaderboard[globalLeaderboard.length - 1];
                                        if (evalAgent.r.zetaStr.localeCompare(lowest.zetaStr) > 0) isGlobalTop = true;
                                    }

                                    if (isGlobalTop) {
                                        globalLeaderboard.push({ 
                                            uid: currentUser.uid, 
                                            swarmId: group.id + 1,
                                            type: evalAgent.t, 
                                            bounce: stats.bounces, 
                                            zetaStr: evalAgent.r.zetaStr 
                                        });
                                        globalLeaderboard.sort((a, b) => b.zetaStr.localeCompare(a.zetaStr));
                                        if (globalLeaderboard.length > 20) globalLeaderboard.pop();
                                        supabaseClient.from('global_state').update({ leaderboard_data: { entries: globalLeaderboard } }).eq('id', 'main_leaderboard').then();
                                    }
                                }
                            });
                        }
                    }
                    
                    group.divergence = Math.sqrt(Math.pow(group.alpha.x - group.beta.x, 2) + Math.pow(group.alpha.y - group.beta.y, 2));
                    if (group.divergence > maxDivergence) maxDivergence = group.divergence;
                });
            }

            // Aggregate Winding (Track Swarm 0 as representative)
            stats.windingNumber = fleet[0].alpha.accumulatedTheta / (2 * Math.PI);

            // ARTIFACT STORAGE
            if (triggerArtifact && artifactGroup && artifacts.length < 20) {
                artifacts.unshift({ 
                    id: `ART-${Math.floor(Math.random()*10000)}`, 
                    bounce: stats.bounces, 
                    tick: globalTick,
                    triggerSwarm: artifactGroup.id + 1,
                    zetaStrAlpha: artifactGroup.zetaStrAlpha, 
                    zetaStrBeta: artifactGroup.zetaStrBeta,
                    desc: `Max Swarm Divergence: ${maxDivergence.toFixed(4)}. Novel mapping phase.`,
                    trailAlpha: artifactGroup.trailAlpha,
                    trailBeta: artifactGroup.trailBeta,
                    gridSnapshot: new Map(visitedGrid) 
                });
            }

            if (swarmHitBoundary && (stats.bounces - lastSaveBounce >= 200)) {
                lastSaveBounce = stats.bounces;
                saveStateToCloud();
            }

            // --- UI UPDATES ---
            if (swarmHitBoundary || Math.random() < 0.05) {
                statBounces.innerText = stats.bounces;
                statDivergence.innerText = maxDivergence.toFixed(4);
                statDivergence.className = maxDivergence > 0.5 ? 'text-red-500' : 'text-cyan-500';
                statWinding.innerText = stats.windingNumber.toFixed(3);
                statCorners.innerText = stats.cornerHits;

                if (activeTab === 'SUPER_BRAIN') {
                    if (superVoidEl) superVoidEl.innerText = minOrbitRadius.toFixed(4);
                    if (swarmDivergenceBars) {
                        swarmDivergenceBars.innerHTML = fleet.map(g => `
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-[9px] w-12 text-gray-500">SWRM ${g.id+1}</span>
                                <div class="flex-1 bg-gray-800 h-2 rounded"><div class="bg-blue-500 h-full transition-all" style="width: ${Math.min(100, g.divergence * 50)}%"></div></div>
                                <span class="text-[9px] text-blue-400 w-10 text-right">${g.divergence.toFixed(3)}</span>
                            </div>
                        `).join('');
                    }
                }

                if (activeTab === 'HYPER') {
                    if(hyperDim) hyperDim.innerText = (1.0 + Math.abs(stats.windingNumber * 0.0142)).toFixed(4);
                    if(hyperErgodicity) hyperErgodicity.style.width = `${Math.min(100, (stats.bounces / 20000) * 100)}%`;
                }

                if (activeTab === 'ZETA') {
                    if(zetaHighEl) zetaHighEl.innerText = zetaStats.high.toLocaleString();
                    if(zetaLowEl) zetaLowEl.innerText = zetaStats.low.toLocaleString();
                }

                if (activeTab === 'MUSEUM') {
                    museumGallery.innerHTML = artifacts.map(art => `
                        <div onclick="openArtifactModal('${art.id}')" class="cursor-pointer border border-yellow-600 bg-yellow-900/20 hover:bg-yellow-900/40 p-2 rounded flex flex-col transition-colors">
                            <div class="text-white font-bold">${art.id} <span class="text-[8px] text-gray-500 ml-1">SWRM ${art.triggerSwarm}</span></div>
                            <div class="text-[7px] text-cyan-400 break-all leading-tight mt-1">α: ${art.zetaStrAlpha}</div>
                            <div class="text-[7px] text-magenta-400 break-all leading-tight mt-1">β: ${art.zetaStrBeta}</div>
                        </div>
                    `).join('');
                }

                if (activeTab === 'STABILITY' && swarmHitBoundary) {
                    if (stabilityHistory.length >= 5) {
                        const intervals = [];
                        for(let i=1; i<stabilityHistory.length; i++) intervals.push(stabilityHistory[i] - stabilityHistory[i-1]);
                        const variance = intervals.reduce((a,b)=>a+Math.abs(b-intervals[0]), 0);
                        const isStable = variance < 10;
                        stabilityLog.innerHTML = `
                            <div class="${isStable ? 'text-lime-400 font-bold bg-lime-900/20' : 'text-gray-500'} p-1 border-b border-gray-800">
                                Global Bounces: [${intervals.join(', ')}] | Var: ${variance} ${isStable ? '- ORBIT DETECTED' : ''}
                            </div>
                        ` + stabilityLog.innerHTML;
                    }
                }

                if (activeTab === 'VOIDS') {
                    if (voidRadius) voidRadius.innerText = minOrbitRadius.toFixed(4);
                    if (voidStructure) {
                        if (minOrbitRadius > 0.1) {
                            voidStructure.innerText = "STRUCTURED (Caustic)";
                            voidStructure.className = "text-lime-400";
                        } else {
                            voidStructure.innerText = "CHAOTIC (Origin crossed)";
                            voidStructure.className = "text-red-400";
                        }
                    }
                }

                if (activeTab === 'RANK') renderLeaderboardUI();
            }
        }

        // --- RULIAD COLOR PROTOCOL ---
        function getRuliadColor(age, maxAge = 2400) {
            if (age < maxAge * 0.06) return '#00ffff';      // CYAN (Present/Hot)
            if (age < maxAge * 0.25) return '#ff00ff';      // MAGENTA (Recent)
            if (age < maxAge * 1.00) return '#ff8800';      // ORANGE (Older/Decaying)
            return '#220044';                               // DEEP PURPLE (Fossilized)
        }

        // --- RENDER LOOP ---
        function renderCanvas() {
            const w = canvas.width; const h = canvas.height;
            const cx = w / 2; const cy = h / 2; const scale = Math.min(w, h) / 2 * 0.9;

            ctx.fillStyle = '#050505'; ctx.fillRect(0, 0, w, h);
            ctx.strokeStyle = '#33ff00'; ctx.lineWidth = 2; ctx.strokeRect(cx - scale, cy - scale, scale * 2, scale * 2);

            // Render all 7 Swarms (14 Agents)
            fleet.forEach(group => {
                // Alpha Trail (White/Cyan)
                if (group.alpha.trail.length > 1) {
                    ctx.beginPath(); ctx.moveTo(cx + group.alpha.trail[0].x * scale, cy + group.alpha.trail[0].y * scale);
                    for (let i = 1; i < group.alpha.trail.length; i++) ctx.lineTo(cx + group.alpha.trail[i].x * scale, cy + group.alpha.trail[i].y * scale);
                    ctx.strokeStyle = 'rgba(0, 255, 255, 0.2)'; ctx.lineWidth = 1.0; ctx.stroke();
                }
                // Beta Trail (Magenta)
                if (group.beta.trail.length > 1) {
                    ctx.beginPath(); ctx.moveTo(cx + group.beta.trail[0].x * scale, cy + group.beta.trail[0].y * scale);
                    for (let i = 1; i < group.beta.trail.length; i++) ctx.lineTo(cx + group.beta.trail[i].x * scale, cy + group.beta.trail[i].y * scale);
                    ctx.strokeStyle = 'rgba(255, 0, 255, 0.2)'; ctx.lineWidth = 1.0; ctx.stroke();
                }

                ctx.beginPath(); ctx.arc(cx + group.alpha.x * scale, cy + group.alpha.y * scale, 2, 0, 2 * Math.PI);
                ctx.fillStyle = '#ffffff'; ctx.fill(); ctx.closePath();
                
                ctx.beginPath(); ctx.arc(cx + group.beta.x * scale, cy + group.beta.y * scale, 2, 0, 2 * Math.PI);
                ctx.fillStyle = '#ff00ff'; ctx.fill(); ctx.closePath();
            });

            // 1. Draw EYES Heatmap (Combined Spatial Density)
            if (activeTab === 'EYES' && eyesCanvas) {
                const eCtx = eyesCanvas.getContext('2d');
                eCtx.clearRect(0, 0, eyesCanvas.width, eyesCanvas.height);
                const ew = eyesCanvas.width; const eh = eyesCanvas.height;
                const gridSize = 40; const cellW = ew / gridSize; const cellH = eh / gridSize;
                
                visitedGrid.forEach((cell, key) => {
                    const [gx, gy] = key.split(',').map(Number);
                    const age = globalTick - cell.lastVisit;
                    eCtx.fillStyle = getRuliadColor(age);
                    eCtx.fillRect((gx/gridSize)*ew + 1, (gy/gridSize)*eh + 1, cellW - 2, cellH - 2);
                });
            }

            // 2. Draw HYPER Poincaré Map
            if (activeTab === 'HYPER' && hyperCanvas) {
                const hCtx = hyperCanvas.getContext('2d');
                hCtx.clearRect(0, 0, hyperCanvas.width, hyperCanvas.height);
                const hw = hyperCanvas.width; const hh = hyperCanvas.height;
                const hGridX = 40; const hGridY = 40; 
                const hCellW = hw / hGridX; const hCellH = hh / hGridY;

                hyperGrid.forEach((cell, key) => {
                    const [gx, gy] = key.split(',').map(Number);
                    const age = globalTick - cell.lastVisit;
                    hCtx.fillStyle = getRuliadColor(age);
                    hCtx.fillRect((gx/hGridX)*hw + 1, (gy/hGridY)*hh + 1, hCellW - 2, hCellH - 2);
                });
            }

            // 3. Draw ZETA Tensor Matrix (Representative Swarm 0)
            if (activeTab === 'ZETA' && zetaCanvas) {
                const zCtx = zetaCanvas.getContext('2d');
                zCtx.clearRect(0, 0, zetaCanvas.width, zetaCanvas.height);
                const zw = zetaCanvas.width; const zh = zetaCanvas.height;
                const zGridSize = 8;
                const zCellW = zw / zGridSize; const zCellH = zh / zGridSize;

                for (let ix = 0; ix < zGridSize; ix++) {
                    for (let iy = 0; iy < zGridSize; iy++) {
                        const weight = Math.abs(Math.sin((ix+1) * fleet[0].beta.x * 3.14 + (iy+1) * fleet[0].beta.y * 2.71 + globalTick * 0.005));
                        const simulatedAge = (1.0 - weight) * 2400; 
                        
                        zCtx.fillStyle = getRuliadColor(simulatedAge);
                        zCtx.fillRect((ix/zGridSize)*zw + 1, (iy/zGridSize)*zh + 1, zCellW - 2, zCellH - 2);
                    }
                }
            }
        }

        // --- MAIN BOOT SEQUENCE ---
        function loop() {
            updatePhysics();
            renderCanvas();
            requestAnimationFrame(loop);
        }

        async function initSupabaseAndStart() {
            try {
                const SUPABASE_URL = "https://xoolmbmnzbsvcqeyqvyi.supabase.co";
                const SUPABASE_ANON_KEY = "xoolmbmnzbsvcqeyqvyi";

                supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

                let localUid = localStorage.getItem('ruliad_uid');
                if (!localUid) {
                    localUid = 'USR-' + crypto.randomUUID();
                    localStorage.setItem('ruliad_uid', localUid);
                }
                currentUser = { uid: localUid };

                await loadStateFromCloud();
                await setupGlobalLeaderboardListener();
                
                saveStatusEl.innerText = 'MULTIWAY SYNCED';
                saveStatusEl.classList.replace('text-yellow-500', 'text-lime-500');
                
                if (!isLoopRunning) {
                    isLoopRunning = true;
                    setupUI();
                    requestAnimationFrame(loop);
                }
            } catch (e) {
                console.warn("Cloud Sync Setup Error. Check API Key:", e);
                saveStatusEl.innerText = 'LOCAL ONLY (UNSAVED)';
                saveStatusEl.classList.replace('text-yellow-500', 'text-gray-500');
                if (!isLoopRunning) {
                    isLoopRunning = true;
                    setupUI();
                    requestAnimationFrame(loop);
                }
            }
        }

        window.onload = initSupabaseAndStart;
    </script>
</body>
</html>