<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Genesis // Inversion</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SUPABASE CLIENT -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* Digital Calculator & LCD Fonts */
        @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap');
        
        body {
            font-family: 'Share Tech Mono', monospace;
            background-color: #000000;
            color: #d1d5db;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.5); border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background: rgba(0,255,255,0.3); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(0,255,255,0.6); }

        /* Munker-White Illusion Global Overlay - Absolute Highest Z-Index */
        .munker-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            pointer-events: none;
            z-index: 999999;
            background: repeating-linear-gradient(
                0deg,
                rgba(0, 0, 0, 0.6) 0px,
                rgba(0, 0, 0, 0.6) 3px,
                rgba(255, 255, 255, 0.25) 3px,
                rgba(255, 255, 255, 0.25) 6px
            );
            mix-blend-mode: normal;
        }

        .glass-panel {
            background: rgba(5, 5, 10, 0.7);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(0, 255, 255, 0.2);
            box-shadow: 0 4px 30px rgba(0,0,0,0.8);
        }
        
        .glass-sub-panel {
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .glitch-text {
            text-shadow: 2px 0 #ff00ff, -2px 0 #00ffff;
        }
    </style>
</head>
<body class="min-h-screen p-4 flex flex-col selection:bg-cyan-900 relative text-shadow-sm">

    <!-- GLOBAL RULIAD MATRIX BACKGROUND (Wolfram CA) & MUNKER ILLUSION -->
    <canvas id="globalBgCanvas" class="fixed inset-0 w-full h-full -z-10 opacity-60"></canvas>
    <div class="munker-overlay"></div>

    <!-- HEADER -->
    <header class="flex justify-between items-end border-b border-cyan-900/80 pb-2 mb-4 relative z-10 glass-panel p-4 rounded-lg">
        <div>
            <h1 class="text-3xl font-black tracking-widest text-white glitch-text">PROJECT GENESIS <span class="text-cyan-500">//</span> INVERSION</h1>
            <h2 class="text-md text-cyan-200 uppercase tracking-widest mt-1">Sim3Colts Build :: Munker-White CA Engine v8</h2>
        </div>
        <div class="flex items-center gap-6">
            <div class="text-right text-xs text-gray-400">
                STATUS: <span class="text-yellow-400 animate-pulse font-bold" id="save-status">CONNECTING SUPABASE...</span><br/>
                ENGINE: AUTONOMOUS EXHAUSTION ITERATION
            </div>
            <a href="https://buymeacoffee.com/brandonkennedy" target="_blank" rel="noopener noreferrer" 
               class="bg-yellow-500/20 border border-yellow-500/80 text-yellow-400 hover:bg-yellow-500 hover:text-black transition-all px-4 py-2 rounded text-sm font-bold tracking-widest flex items-center gap-2 shadow-[0_0_15px_rgba(255,255,0,0.4)]">
                <span>☕</span> TIP JAR
            </a>
        </div>
    </header>

    <!-- MAIN GRID -->
    <div class="flex-1 grid grid-cols-1 lg:grid-cols-3 gap-6 relative z-10">
        
        <!-- LEFT PANE: CANVAS & CONTROLS -->
        <div class="lg:col-span-2 flex flex-col gap-4">
            
            <div class="relative w-full h-[500px] glass-panel rounded-lg overflow-hidden shadow-[0_0_50px_rgba(0,255,255,0.15)]" id="canvas-container">
                <canvas id="simCanvas" class="absolute inset-0 w-full h-full"></canvas>
                <div class="absolute top-2 left-2 text-[11px] text-cyan-100/90 select-none pointer-events-none bg-black/80 px-2 py-1 rounded border border-cyan-900/50">
                    GEOMETRY: SQUARE_STRICT<br/>
                    MODE: INVERSION MAPPING (14 AGENTS)<br/>
                    <span class="text-cyan-400">7x ALPHA (CONTROL)</span> | <span class="text-magenta-400">7x BETA (OBSERVER)</span>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4 glass-panel p-4 rounded-lg text-sm">
                <div class="glass-sub-panel p-3 rounded">
                    <label class="flex justify-between text-cyan-100 mb-1">
                        <span>SONIC DRIVE (Time Δt)</span>
                        <span class="text-cyan-400 font-bold" id="speedLabel">x5</span>
                    </label>
                    <input type="range" id="speedInput" min="1" max="50" value="5" class="w-full accent-cyan-500" />
                </div>
                <div class="glass-sub-panel p-3 rounded">
                    <label class="flex justify-between text-magenta-100 mb-1">
                        <span>SMITH TRAIL MEMORY</span>
                        <span class="text-magenta-400 font-bold" id="trailLabel">200 steps</span>
                    </label>
                    <input type="range" id="trailInput" min="10" max="800" value="200" class="w-full accent-magenta-500" />
                </div>
            </div>
        </div>

        <!-- RIGHT PANE: QUADRATIC REALITY MATRIX & OBSERVABLES -->
        <div class="flex flex-col gap-4 h-full">
            
            <div class="glass-panel p-4 rounded-lg grid grid-cols-2 gap-y-4 gap-x-2 text-sm relative overflow-hidden">
                <div class="col-span-2 border-b border-cyan-800/80 pb-2 mb-1 text-cyan-300 font-bold tracking-widest flex justify-between text-base">
                    <span>SYSTEM MACROSTATES</span>
                    <span class="text-cyan-400">Δ DIVERGENCE: <span id="statDivergence" class="text-white">0.000</span></span>
                </div>
                
                <div class="flex flex-col glass-sub-panel p-2 rounded text-center">
                    <span class="text-gray-400 text-[11px] tracking-widest">AGG. WINDING ($W$)</span>
                    <span class="text-2xl text-cyan-400 font-bold mt-1" id="statWinding">0.000</span>
                </div>
                
                <div class="flex flex-col glass-sub-panel p-2 rounded text-center">
                    <span class="text-gray-400 text-[11px] tracking-widest">CORNER HITS (ε)</span>
                    <span class="text-2xl text-magenta-400 font-bold mt-1" id="statCorners">0</span>
                </div>

                <div class="flex flex-col glass-sub-panel p-2 rounded text-center">
                    <span class="text-gray-400 text-[11px] tracking-widest">SWARM IMPACTS</span>
                    <span class="text-xl text-white mt-1" id="statBounces">0</span>
                </div>

                <!-- NEW SEARCH EPOCH TRACKER -->
                <div class="flex flex-col glass-sub-panel p-2 rounded text-center border border-lime-900/80 bg-lime-900/20">
                    <span class="text-lime-300 text-[11px] tracking-widest font-bold">SEARCH EPOCH</span>
                    <span class="text-2xl text-lime-400 font-bold mt-1 shadow-lime" id="statEpoch">1</span>
                </div>
            </div>

            <div class="flex-1 flex flex-col glass-panel rounded-lg overflow-hidden min-h-[300px]">
                <div class="flex glass-sub-panel border-b border-cyan-800/80 text-xs overflow-x-auto" id="tab-headers"></div>
                
                <div class="flex-1 p-3 relative">
                    <div id="tab-SUPER_BRAIN" class="hidden h-full flex flex-col text-sm text-blue-200">
                        <h3 class="text-blue-300 mb-2 border-b border-blue-800/80 pb-1 font-bold tracking-widest">HIVE-MIND CROSS-REFERENCE</h3>
                        <div class="flex-1 overflow-y-auto space-y-3 pr-2">
                            <div class="glass-sub-panel border-blue-900/80 p-2 rounded">
                                <p class="text-blue-400 font-bold mb-1 tracking-widest">COLLECTIVE INVARIANTS</p>
                                <div class="flex justify-between"><span class="text-gray-300">Energy (Velocity):</span> <span class="text-lime-400 font-bold">CONSERVATION</span></div>
                                <div class="flex justify-between mt-1"><span class="text-gray-300">Phase Volume:</span> <span class="text-lime-400 font-bold">LIOUVILLE (Alpha)</span></div>
                            </div>
                            <div class="glass-sub-panel border-blue-900/80 p-2 rounded">
                                <p class="text-blue-400 font-bold mb-1 tracking-widest">SWARM VARIANTS (SPREAD)</p>
                                <div id="swarm-divergence-bars" class="space-y-1"></div>
                            </div>
                            <div class="glass-sub-panel border-blue-900/80 p-2 rounded">
                                <p class="text-blue-400 font-bold mb-1 tracking-widest">VOID DETECTION</p>
                                <div class="flex justify-between"><span class="text-gray-300">Shared Caustic Radius:</span> <span id="super-void" class="text-cyan-400 font-bold">0.000</span></div>
                            </div>
                        </div>
                    </div>

                    <!-- NEW STRUCTURE RATIO TAB -->
                    <div id="tab-STRUCTURE_RATIO" class="hidden h-full flex flex-col text-sm text-purple-300">
                        <h3 class="text-purple-200 mb-2 border-b border-purple-800/80 pb-1 font-bold tracking-widest">MORPHOLOGICAL RATIO (Φ)</h3>
                        <div class="flex-1 flex flex-col gap-2">
                            <p class="text-[9px] text-gray-400">Tracking the convergence of Structured Events (Corners/Inversions/Orbits) against Chaotic Dispersion (Divergence &gt; 0.3). Flatlines reveal invariants.</p>
                            <div class="glass-sub-panel p-2 rounded grid grid-cols-3 gap-2 text-center text-xs">
                                <div><span class="text-gray-400 text-[10px]">STRUCTURED</span><br><span id="val-structured" class="text-lime-400 font-bold">0</span></div>
                                <div><span class="text-gray-400 text-[10px]">RATIO (Φ)</span><br><span id="val-ratio" class="text-purple-400 font-bold text-lg">0.000</span></div>
                                <div><span class="text-gray-400 text-[10px]">CHAOTIC</span><br><span id="val-chaotic" class="text-red-400 font-bold">0</span></div>
                            </div>
                            <!-- NEW EMERGENCE TREND TRACKER -->
                            <div class="mt-1 text-center text-[10px] font-bold tracking-widest text-cyan-500 bg-black/50 p-1 rounded border border-cyan-900/50" id="chaos-trend">
                                EMERGENCE TREND: GATHERING DATA...
                            </div>
                            <div class="flex-1 relative glass-sub-panel rounded overflow-hidden mt-1">
                                <canvas id="ratioCanvas" class="absolute inset-0 w-full h-full opacity-90"></canvas>
                            </div>
                        </div>
                    </div>

                    <div id="tab-EYES" class="hidden h-full flex flex-col text-sm text-blue-400">
                        <h3 class="text-blue-200 mb-2 border-b border-blue-800/80 pb-1 font-bold tracking-widest">GLOBAL COLLECTIVE MAP</h3>
                        <div class="flex-1 relative glass-sub-panel overflow-hidden rounded">
                            <canvas id="eyesCanvas" class="absolute inset-0 w-full h-full opacity-100"></canvas>
                        </div>
                    </div>

                    <div id="tab-STABILITY" class="hidden h-full flex flex-col text-sm text-indigo-300">
                        <h3 class="text-indigo-200 mb-2 border-b border-indigo-800/80 pb-1 font-bold tracking-widest">ORBITAL STABILITY METRICS</h3>
                        <div class="flex-1 overflow-y-auto space-y-2 pr-2" id="stability-log">
                            <div class="text-gray-400">Calculating periodic orbital variance...</div>
                        </div>
                    </div>

                    <div id="tab-VOIDS" class="hidden h-full flex flex-col text-sm text-teal-300">
                        <h3 class="text-teal-200 mb-2 border-b border-teal-800/80 pb-1 font-bold tracking-widest">CAUSTIC VOID TOPOLOGY</h3>
                        <div class="grid grid-cols-2 gap-2 mb-2">
                            <div class="glass-sub-panel border-teal-900/80 p-2 rounded">
                                <p class="text-gray-400 text-xs">Void Structure</p>
                                <p class="text-white font-bold text-lg" id="void-structure">Analyzing...</p>
                            </div>
                            <div class="glass-sub-panel border-teal-900/80 p-2 rounded">
                                <p class="text-gray-400 text-xs">Min. Radius (r)</p>
                                <p class="text-teal-400 font-bold text-xl" id="void-radius">0.000</p>
                            </div>
                        </div>
                    </div>

                    <div id="tab-MUSEUM" class="hidden h-full flex flex-col text-sm text-yellow-300">
                        <h3 class="text-yellow-200 mb-2 border-b border-yellow-800/80 pb-1 font-bold tracking-widest">INVERSION SHAPE ARTIFACTS</h3>
                        <p class="text-[10px] text-gray-400 mb-2">Logging structural inversions (origin crossing) and corner singularities.</p>
                        <div class="flex-1 grid grid-cols-2 gap-2 overflow-y-auto pr-2" id="museum-gallery"></div>
                    </div>

                    <div id="tab-HYPER" class="hidden h-full flex flex-col text-sm text-cyan-300">
                        <h3 class="text-cyan-200 mb-2 border-b border-cyan-800/80 pb-1 font-bold tracking-widest">PHASE DIMENSIONALITY</h3>
                        <div class="flex-1 grid grid-cols-2 gap-4">
                            <div class="glass-sub-panel p-2 rounded">
                                <p class="text-gray-400 text-xs">Effective Dim $d$</p>
                                <p class="text-2xl text-lime-400 font-bold" id="hyper-dim">1.0000</p>
                            </div>
                            <div class="glass-sub-panel p-2 rounded">
                                <p class="text-gray-400 text-xs">Ergodicity</p>
                                <div class="w-full bg-black/80 h-4 mt-1 rounded overflow-hidden border border-gray-700">
                                    <div id="hyper-ergodicity" class="bg-magenta-500 h-full" style="width: 0%; box-shadow: 0 0 10px #ff00ff"></div>
                                </div>
                            </div>
                            <div class="col-span-2 mt-2">
                                <p class="text-gray-300 mb-1 text-xs">Poincaré Section (x, θ) Map</p>
                                <div class="w-full h-32 glass-sub-panel relative overflow-hidden rounded">
                                    <canvas id="hyperCanvas" class="absolute inset-0 w-full h-full opacity-100"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="tab-ZETA" class="hidden h-full flex flex-col text-sm text-magenta-300">
                        <h3 class="text-magenta-200 mb-2 border-b border-magenta-800/80 pb-1 font-bold tracking-widest">BLADE ALGORITHMIC HEURISTICS</h3>
                        <div class="grid grid-cols-2 gap-4 mb-2">
                            <div class="glass-sub-panel p-2 rounded">
                                <p class="text-gray-400 text-xs">High Zeta (&gt; 0.5)</p>
                                <p class="text-xl text-cyan-400 font-bold" id="zeta-high">0</p>
                            </div>
                            <div class="glass-sub-panel p-2 rounded">
                                <p class="text-gray-400 text-xs">Low Zeta (&lt; 0.5)</p>
                                <p class="text-xl text-red-400 font-bold" id="zeta-low">0</p>
                            </div>
                        </div>
                        <p class="mb-2 text-gray-300 mt-2 text-xs">Quadratic Reality Tensor Matrix (Swarm 1)</p>
                        <div class="flex-1 relative glass-sub-panel min-h-[150px] rounded">
                            <canvas id="zetaCanvas" class="absolute inset-0 w-full h-full opacity-100"></canvas>
                        </div>
                    </div>

                    <div id="tab-RANK" class="hidden h-full flex flex-col text-sm text-emerald-300">
                        <h3 class="text-emerald-200 mb-2 border-b border-emerald-800/80 pb-1 font-bold tracking-widest">GLOBAL LEADERBOARD</h3>
                        <div class="flex justify-between text-[11px] text-gray-400 mb-2 px-1">
                            <span>RANK / TYPE / UID</span>
                            <span>ZETA SCORE (ζ)</span>
                        </div>
                        <div id="leaderboard-container" class="flex-1 overflow-y-auto space-y-1 pr-2">
                            <span class="text-gray-500">Syncing multiway data stream...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ARTIFACT RENDER MODAL -->
    <div id="artifactModal" class="fixed inset-0 z-[90000] hidden items-center justify-center p-8 bg-black/80 backdrop-blur-md">
        <div class="glass-panel w-full max-w-5xl h-[85vh] flex flex-col rounded-xl shadow-[0_0_100px_rgba(0,255,255,0.4)] overflow-hidden border-2 border-cyan-500">
            <div class="bg-gray-900/90 border-b border-cyan-500 p-4 flex justify-between items-center">
                <h2 class="text-cyan-400 font-bold tracking-widest text-xl glitch-text" id="modal-title">ARTIFACT RENDER</h2>
                <button onclick="closeModal()" class="text-red-500 hover:text-red-300 text-3xl font-bold px-2 transition-colors leading-none">&times;</button>
            </div>
            
            <div class="flex-1 grid grid-cols-2 p-4 gap-4 bg-black/60 relative">
                <div class="flex flex-col glass-sub-panel rounded-lg relative overflow-hidden">
                    <div class="absolute top-0 left-0 right-0 bg-black/90 border-b border-cyan-800/80 p-2 z-10 text-center text-xs text-cyan-300 font-bold tracking-widest flex justify-between px-4">
                        <span>2D TRAJECTORY SPACE</span>
                        <span class="text-yellow-400 animate-pulse">LIVE RECONSTRUCTION</span>
                    </div>
                    <canvas id="modalTrajCanvas" class="w-full h-full"></canvas>
                </div>
                <div class="flex flex-col glass-sub-panel rounded-lg relative overflow-hidden">
                    <div class="absolute top-0 left-0 right-0 bg-black/90 border-b border-magenta-800/80 p-2 z-10 text-center text-xs text-magenta-300 font-bold tracking-widest">
                        RULIAD GENERATION
                    </div>
                    <canvas id="modalRuliadCanvas" class="w-full h-full"></canvas>
                </div>
            </div>
            
            <!-- REPRODUCIBILITY MANIFEST -->
            <div class="bg-gray-900/90 p-4 border-t border-cyan-500 text-sm text-gray-300" id="modal-desc"></div>
        </div>
    </div>

    <!-- ENGINE SCRIPT & CLOUD SYNC -->
    <script>
        const BOX_SIZE = 1;
        const CORNER_TOLERANCE = 0.05;
        const INITIAL_SPEED = 0.015;
        const NUM_SWARMS = 7;

        let supabaseClient;
        let currentUser;
        let isLoopRunning = false;
        let isSaving = false;
        let lastSaveBounce = 0;
        let lastSaveTime = 0; 
        let lastCollectiveSyncTime = 0;

        // AUTO-ITERATION (EPOCH) TRACKING
        let searchEpoch = 1;
        let baseAngleShift = 0;
        let lastHighZetaBounce = 0; // Tracks phase space exhaustion

        // MORPHOLOGICAL RATIO TRACKING
        let structuredEvents = 0;
        let chaoticEvents = 0;
        let ratioHistory = []; // Array of calculated ratio values

        function getHyperPrecisionZeta(baseNum, x, y) {
            let str = baseNum.toFixed(15);
            let seed = Math.abs(Math.floor(x * 10000000) ^ Math.floor(y * 10000000));
            if (seed === 0) seed = 123456789; 
            while(str.length < 103) { 
                seed = (seed * 9301 + 49297) % 233280; 
                let fraction = seed / 233280;
                str += Math.floor(fraction * 1e10).toString().padStart(10, '0');
            }
            return str.substring(0, 103);
        }

        let activeTab = 'SUPER_BRAIN';
        let speed = 5;
        let trailLength = 200; 
        
        let stats = { bounces: 0, cornerHits: 0, windingNumber: 0, lyapunovProxy: 0.0, freeConfigs: 180360 };
        let zetaStats = { high: 0, low: 0, steers: 0 };
        
        function initializeFleet(angleShift) {
            return Array.from({ length: NUM_SWARMS }, (_, i) => {
                const angle = (i / NUM_SWARMS) * Math.PI * 2 + angleShift;
                const r = 0.3;
                const sx = Math.cos(angle) * r;
                const sy = Math.sin(angle) * r;
                const stheta = angle + Math.PI/4; 
                const vx = Math.cos(stheta) * INITIAL_SPEED;
                const vy = Math.sin(stheta) * INITIAL_SPEED;

                return {
                    id: i,
                    alpha: { x: sx, y: sy, prevX: sx, prevY: sy, vx: vx, vy: vy, theta: stheta, accumulatedTheta: 0, trail: [] },
                    beta:  { x: sx, y: sy, prevX: sx, prevY: sy, vx: vx, vy: vy, theta: stheta, accumulatedTheta: 0, trail: [] },
                    divergence: 0, bounces: 0
                };
            });
        }
        
        let fleet = initializeFleet(baseAngleShift);

        let visitedGrid = new Map(); 
        let hyperGrid = new Map(); 
        let globalTick = 0; 
        let artifacts = [];
        let globalLeaderboard = []; 
        
        let stabilityHistory = [];
        let stabilityLogArray = []; 
        let minOrbitRadius = Infinity;

        // CYCLIC CELLULAR AUTOMATON BG
        let bgCols = 0, bgRows = 0;
        let bgGridCA = [];
        const BG_CELL_SIZE = 25;

        function initBgGrid(w, h) {
            bgCols = Math.ceil(w / BG_CELL_SIZE);
            bgRows = Math.ceil(h / BG_CELL_SIZE);
            bgGridCA = new Array(bgCols).fill(0).map(() => new Array(bgRows).fill(0).map(() => Math.floor(Math.random() * 7)));
        }

        function updateBgGrid() {
            let newGrid = new Array(bgCols).fill(0).map(() => new Array(bgRows).fill(0));
            for (let x = 0; x < bgCols; x++) {
                for (let y = 0; y < bgRows; y++) {
                    let state = bgGridCA[x][y];
                    let nextState = (state + 1) % 7;
                    let changed = false;
                    for (let dx = -1; dx <= 1; dx++) {
                        for (let dy = -1; dy <= 1; dy++) {
                            let nx = (x + dx + bgCols) % bgCols;
                            let ny = (y + dy + bgRows) % bgRows;
                            if (bgGridCA[nx][ny] === nextState) { changed = true; break; }
                        }
                        if (changed) break;
                    }
                    newGrid[x][y] = changed ? nextState : state;
                }
            }
            bgGridCA = newGrid;
        }

        const canvas = document.getElementById('simCanvas');
        const ctx = canvas.getContext('2d');
        const globalBgCanvas = document.getElementById('globalBgCanvas');
        const eyesCanvas = document.getElementById('eyesCanvas');
        const hyperCanvas = document.getElementById('hyperCanvas');
        const zetaCanvas = document.getElementById('zetaCanvas');
        const ratioCanvas = document.getElementById('ratioCanvas');
        
        const tabs = ['SUPER_BRAIN', 'EYES', 'STRUCTURE_RATIO', 'STABILITY', 'VOIDS', 'MUSEUM', 'HYPER', 'ZETA', 'RANK'];

        function renderTabButtons() {
            document.getElementById('tab-headers').innerHTML = tabs.map(tab => `
                <button onclick="window.switchTab('${tab}')" class="px-3 py-2 flex-shrink-0 transition-all ${activeTab === tab ? 'bg-cyan-900/50 text-white border-t-2 border-cyan-400 font-bold shadow-[0_0_10px_rgba(0,255,255,0.5)]' : 'text-gray-400 hover:text-cyan-200 border-t-2 border-transparent'}">${tab.replace('_', ' ')}</button>
            `).join('');
        }

        window.switchTab = function(tab) {
            activeTab = tab;
            renderTabButtons();
            [...tabs, 'OTHER'].forEach(t => { const el = document.getElementById(`tab-${t}`); if (el) el.classList.add('hidden'); });
            if (tabs.includes(tab)) {
                document.getElementById(`tab-${tab}`).classList.remove('hidden');
                if (tab === 'RANK') renderLeaderboardUI();
                setTimeout(() => window.dispatchEvent(new Event('resize')), 10);
            }
        };

        // --- CLOUD SYNC LOGIC (NO GRID PAYLOADS FOR DB STABILITY) ---
        async function loadStateFromCloud() {
            if (!supabaseClient || !currentUser) return;
            try {
                const { data, error } = await supabaseClient.from('saves').select('state_data').eq('user_id', currentUser.uid).single();
                if (error && error.code !== 'PGRST116') throw error; 

                if (data && data.state_data) {
                    const saved = data.state_data;
                    stats = saved.stats || stats;
                    zetaStats = saved.zetaStats || zetaStats;
                    searchEpoch = saved.searchEpoch || 1;
                    baseAngleShift = saved.baseAngleShift || 0;
                    
                    if (saved.fleet && saved.fleet.length === NUM_SWARMS) {
                        fleet = saved.fleet.map((g, i) => ({
                            id: i,
                            alpha: { ...fleet[i].alpha, ...g.alpha, trail: [] },
                            beta: { ...fleet[i].beta, ...g.beta, trail: [] },
                            divergence: g.divergence || 0, bounces: g.bounces || 0
                        }));
                    }
                    globalTick = saved.globalTick || 0;
                    artifacts = saved.artifacts || [];
                    lastSaveBounce = stats.bounces;
                }
            } catch (e) { console.error("Cloud load failed:", e); }
        }

        async function setupGlobalLeaderboardListener() {
            if (!supabaseClient) return;
            const { data } = await supabaseClient.from('global_state').select('leaderboard_data').eq('id', 'main_leaderboard').single();
            if (data && data.leaderboard_data) {
                globalLeaderboard = data.leaderboard_data.entries || [];
                if (activeTab === 'RANK') renderLeaderboardUI();
            }
            supabaseClient.channel('public:global_state').on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'global_state', filter: 'id=eq.main_leaderboard' }, payload => {
                if (payload.new && payload.new.leaderboard_data) {
                    globalLeaderboard = payload.new.leaderboard_data.entries || [];
                    if (activeTab === 'RANK') renderLeaderboardUI();
                }
            }).subscribe();
        }

        async function saveStateToCloud() {
            if (!supabaseClient || !currentUser || isSaving) return;
            isSaving = true;
            document.getElementById('save-status').innerText = 'SYNCING REALITY...';
            document.getElementById('save-status').className = 'text-yellow-500 animate-pulse font-bold';
            
            try {
                const state = {
                    stats, zetaStats, searchEpoch, baseAngleShift,
                    fleet: fleet.map(g => ({
                        alpha: { x: g.alpha.x, y: g.alpha.y, vx: g.alpha.vx, vy: g.alpha.vy, theta: g.alpha.theta },
                        beta: { x: g.beta.x, y: g.beta.y, vx: g.beta.vx, vy: g.beta.vy, theta: g.beta.theta },
                        divergence: g.divergence, bounces: g.bounces
                    })),
                    globalTick, artifacts
                };
                
                const { error: saveError } = await supabaseClient.from('saves').upsert({ user_id: currentUser.uid, state_data: state });
                if (saveError) throw saveError;

                document.getElementById('save-status').innerText = 'MULTIWAY CLOUD SYNCED';
                document.getElementById('save-status').className = 'text-lime-500 font-bold';
            } catch (e) {
                document.getElementById('save-status').innerText = 'SYNC ERROR (Check RLS/API KEY)';
                document.getElementById('save-status').className = 'text-red-500 font-bold';
            }
            isSaving = false;
        }

        window.addEventListener('beforeunload', () => { if (stats.bounces > lastSaveBounce && supabaseClient && currentUser) saveStateToCloud(); });

        function renderLeaderboardUI() {
            const lc = document.getElementById('leaderboard-container');
            if (globalLeaderboard.length === 0) { lc.innerHTML = `<span class="text-gray-500">No configurations cataloged yet.</span>`; return; }
            lc.innerHTML = globalLeaderboard.map((entry, index) => {
                const isMe = currentUser && entry.uid === currentUser.uid;
                const displayUid = entry.uid.split('-')[0] + '...';
                const color = entry.type === 'ALPHA' ? 'text-cyan-400' : 'text-magenta-400';
                return `
                <div class="flex flex-col border-b border-emerald-900/50 py-1 ${index === 0 ? 'bg-emerald-900/50 px-2 rounded border border-emerald-400' : ''} ${isMe ? 'border-l-4 border-l-lime-400 pl-2 bg-emerald-900/30' : ''}">
                    <div class="flex justify-between w-full items-center">
                        <div class="${index === 0 ? 'text-emerald-200 font-bold text-lg' : 'text-emerald-500'}">#${index + 1} <span class="${color} text-[9px] ml-1">[SWRM-${entry.swarmId} ${entry.type}]</span></div>
                        <div class="text-[10px] text-gray-300 font-bold tracking-widest">${isMe ? '<span class="text-lime-400 drop-shadow-[0_0_5px_rgba(0,255,0,0.8)]">YOU</span>' : displayUid}</div>
                    </div>
                    <div class="font-bold text-[8.5px] text-emerald-300 break-all leading-tight mt-1">ζ: ${entry.zetaStr}</div>
                </div>`
            }).join('');
        }

        // --- ARTIFACT MODAL PLAYBACK LOGIC ---
        let modalArt = null;
        let modalTick = 0;
        let modalAnimId = null;
        let modalLocalGrid = new Map();

        function playModal() {
            if (!modalArt) return;
            
            const tCtx = document.getElementById('modalTrajCanvas').getContext('2d');
            const rCtx = document.getElementById('modalRuliadCanvas').getContext('2d');
            const w = tCtx.canvas.width; const h = tCtx.canvas.height;
            const cx = w/2; const cy = h/2; const scale = Math.min(w,h)/2 * 0.9;
            const gridSize = 40; const cellW = w/gridSize; const cellH = h/gridSize;

            if (modalTick === 0) {
                tCtx.fillStyle = '#050505'; tCtx.fillRect(0, 0, w, h);
                rCtx.fillStyle = '#050505'; rCtx.fillRect(0, 0, w, h);
                modalLocalGrid.clear();
                tCtx.strokeStyle = '#33ff00'; tCtx.lineWidth = 1; tCtx.strokeRect(cx - scale, cy - scale, scale*2, scale*2);
            } else {
                tCtx.fillStyle = 'rgba(5, 5, 5, 0.1)'; tCtx.fillRect(0, 0, w, h);
                tCtx.strokeStyle = '#33ff00'; tCtx.lineWidth = 1; tCtx.strokeRect(cx - scale, cy - scale, scale*2, scale*2);
            }

            const aTrail = modalArt.trailAlpha || [];
            const bTrail = modalArt.trailBeta || [];
            const maxLen = Math.max(aTrail.length, bTrail.length);

            if (modalTick < maxLen) {
                // Alpha
                if (modalTick > 0 && modalTick < aTrail.length) {
                    const p1 = aTrail[modalTick-1]; const p2 = aTrail[modalTick];
                    tCtx.beginPath(); tCtx.moveTo(cx + p1.x * scale, cy + p1.y * scale); tCtx.lineTo(cx + p2.x * scale, cy + p2.y * scale);
                    tCtx.strokeStyle = '#00ffff'; tCtx.lineWidth = 2; tCtx.stroke();
                    
                    const gx = Math.floor((p2.x + BOX_SIZE) * 20); const gy = Math.floor((p2.y + BOX_SIZE) * 20);
                    modalLocalGrid.set(`${gx},${gy}`, modalTick);
                }
                // Beta
                if (modalTick > 0 && modalTick < bTrail.length) {
                    const p1 = bTrail[modalTick-1]; const p2 = bTrail[modalTick];
                    tCtx.beginPath(); tCtx.moveTo(cx + p1.x * scale, cy + p1.y * scale); tCtx.lineTo(cx + p2.x * scale, cy + p2.y * scale);
                    tCtx.strokeStyle = '#ff00ff'; tCtx.lineWidth = 2; tCtx.stroke();
                    
                    const gx = Math.floor((p2.x + BOX_SIZE) * 20); const gy = Math.floor((p2.y + BOX_SIZE) * 20);
                    modalLocalGrid.set(`${gx},${gy}`, modalTick);
                }

                // Render reconstructed Ruliad blocks
                rCtx.fillStyle = '#050505'; rCtx.fillRect(0, 0, w, h);
                modalLocalGrid.forEach((visitTick, key) => {
                    const [gx, gy] = key.split(',').map(Number);
                    const age = modalTick - visitTick;
                    rCtx.fillStyle = getRuliadColorState(age * 5); // Scale age to look cool in short loop
                    rCtx.fillRect((gx/gridSize)*w+1, (gy/gridSize)*h+1, cellW-2, cellH-2);
                });

                modalTick++;
            } else {
                if (modalTick > maxLen + 60) modalTick = 0;
                else modalTick++;
            }

            modalAnimId = requestAnimationFrame(playModal);
        }

        function openArtifactModal(id) {
            const art = artifacts.find(a => a.id === id);
            if (!art) return;
            
            modalArt = art;
            document.getElementById('modal-title').innerText = `ARTIFACT // ${art.id}`;
            
            // Generate Reproducibility Manifest (Calculator layout)
            const k = art.kinematics;
            const kinHTML = k ? `
                <div class="bg-black/80 p-2 rounded border border-gray-700 text-[10px] text-gray-400">
                    <div class="text-white border-b border-gray-600 mb-1 tracking-widest">REPRODUCIBILITY MANIFEST</div>
                    <div><span class="text-cyan-400">ALPHA X:</span> ${k.alpha.x.toFixed(8)} | <span class="text-cyan-400">Y:</span> ${k.alpha.y.toFixed(8)}</div>
                    <div><span class="text-cyan-400">ALPHA Vx:</span> ${k.alpha.vx.toFixed(8)} | <span class="text-cyan-400">Vy:</span> ${k.alpha.vy.toFixed(8)}</div>
                    <div class="mt-1"><span class="text-magenta-400">BETA X:</span> ${k.beta.x.toFixed(8)} | <span class="text-magenta-400">Y:</span> ${k.beta.y.toFixed(8)}</div>
                    <div><span class="text-magenta-400">BETA Vx:</span> ${k.beta.vx.toFixed(8)} | <span class="text-magenta-400">Vy:</span> ${k.beta.vy.toFixed(8)}</div>
                </div>
            ` : `<div class="text-gray-600">Kinematics manifest not available for epoch shifts.</div>`;

            document.getElementById('modal-desc').innerHTML = `
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <div class="text-cyan-400 font-bold mb-1 border-b border-cyan-800 tracking-widest">TRIGGER: ${art.triggerSwarm === 'ALL' ? 'GLOBAL SHIFT' : 'SWRM ' + art.triggerSwarm}</div>
                        <div class="text-gray-300">α Zeta: <span class="text-cyan-300">${art.zetaStrAlpha.substring(0,25)}...</span></div>
                        <div class="text-gray-300">β Zeta: <span class="text-magenta-300">${art.zetaStrBeta.substring(0,25)}...</span></div>
                        <div class="text-yellow-400 font-bold mt-2 text-xs uppercase">${art.desc}</div>
                    </div>
                    ${kinHTML}
                </div>
            `;
            
            document.getElementById('artifactModal').classList.remove('hidden');
            document.getElementById('artifactModal').classList.add('flex');

            const tCtx = document.getElementById('modalTrajCanvas');
            tCtx.width = tCtx.parentElement.clientWidth;
            tCtx.height = tCtx.parentElement.clientHeight - 30; 
            document.getElementById('modalRuliadCanvas').width = tCtx.width; 
            document.getElementById('modalRuliadCanvas').height = tCtx.height;

            modalTick = 0;
            cancelAnimationFrame(modalAnimId);
            playModal();
        }

        window.closeModal = function() {
            cancelAnimationFrame(modalAnimId);
            document.getElementById('artifactModal').classList.add('hidden');
            document.getElementById('artifactModal').classList.remove('flex');
        }

        function setupUI() {
            function resize() {
                const rect = canvas.parentElement.getBoundingClientRect();
                canvas.width = rect.width; canvas.height = rect.height;
                [globalBgCanvas, eyesCanvas, hyperCanvas, zetaCanvas, ratioCanvas].forEach(c => {
                    if(c && c.parentElement) {
                        const r = c.parentElement === document.body ? {width: window.innerWidth, height: window.innerHeight} : c.parentElement.getBoundingClientRect();
                        if (r.width > 0 && r.height > 0) { c.width = r.width; c.height = r.height; }
                    }
                });
                if(globalBgCanvas.width > 0) initBgGrid(globalBgCanvas.width, globalBgCanvas.height);
            }
            window.addEventListener('resize', resize);
            resize();

            document.getElementById('speedInput').addEventListener('input', (e) => { speed = parseInt(e.target.value); document.getElementById('speedLabel').innerText = `x${speed}`; });
            document.getElementById('trailInput').addEventListener('input', (e) => { trailLength = parseInt(e.target.value); document.getElementById('trailLabel').innerText = `${trailLength} steps`; });
            renderTabButtons(); window.switchTab(activeTab);
        }

        function moveAgent(agent, isBetaObserver) {
            agent.prevX = agent.x; 
            agent.prevY = agent.y;
            let nextX = agent.x + agent.vx;
            let nextY = agent.y + agent.vy;
            let bounced = false; let cornerHit = false;

            if (nextX > BOX_SIZE) { nextX = BOX_SIZE - (nextX - BOX_SIZE); agent.vx *= -1; bounced = true; } 
            else if (nextX < -BOX_SIZE) { nextX = -BOX_SIZE + (-BOX_SIZE - nextX); agent.vx *= -1; bounced = true; }
            if (nextY > BOX_SIZE) { nextY = BOX_SIZE - (nextY - BOX_SIZE); agent.vy *= -1; bounced = true; } 
            else if (nextY < -BOX_SIZE) { nextY = -BOX_SIZE + (-BOX_SIZE - nextY); agent.vy *= -1; bounced = true; }

            if (bounced) {
                const isCornerX = Math.abs(nextX) >= BOX_SIZE - CORNER_TOLERANCE;
                const isCornerY = Math.abs(nextY) >= BOX_SIZE - CORNER_TOLERANCE;
                cornerHit = isCornerX && isCornerY;
            }

            const radius = Math.sqrt(nextX*nextX + nextY*nextY);
            if (radius < minOrbitRadius) minOrbitRadius = radius;

            agent.x = nextX; agent.y = nextY;

            // Mathematical Origin Crossing (Inversion)
            let originCross = false;
            if (Math.sign(agent.x) !== Math.sign(agent.prevX) && Math.sign(agent.y) !== Math.sign(agent.prevY)) {
                originCross = true;
            }

            const gridSegments = 20; 
            const gridX = Math.floor((agent.x + BOX_SIZE) * gridSegments);
            const gridY = Math.floor((agent.y + BOX_SIZE) * gridSegments);
            const gridKey = `${gridX},${gridY}`;
            
            const cellData = visitedGrid.get(gridKey) || { density: 0, lastVisit: 0 };
            visitedGrid.set(gridKey, { density: cellData.density + 1, lastVisit: globalTick });

            let baseZeta = Math.max(0.0, 1.0 - (cellData.density / 15.0));
            let fracX = Math.abs((agent.x + BOX_SIZE) * gridSegments - gridX - 0.5); 
            let fracY = Math.abs((agent.y + BOX_SIZE) * gridSegments - gridY - 0.5);
            let microVariance = (0.5 - fracX) * (0.5 - fracY) * 0.39996; 
            
            let currentZetaNum = baseZeta > 0 ? Math.min(1.0, baseZeta + microVariance) : 0;
            let currentZetaStr = getHyperPrecisionZeta(currentZetaNum, agent.x, agent.y);

            if (bounced) {
                let nextTheta = agent.theta;
                if (nextX !== 0 || nextY !== 0) nextTheta = Math.atan2(nextY, nextX);
                let dTheta = nextTheta - agent.theta;
                if (dTheta > Math.PI) dTheta -= 2 * Math.PI; if (dTheta < -Math.PI) dTheta += 2 * Math.PI;
                agent.accumulatedTheta += dTheta; agent.theta = nextTheta;

                const hyperX = Math.floor((agent.x + BOX_SIZE) * 20); 
                const hyperTheta = Math.floor(((agent.theta + Math.PI) / (2 * Math.PI)) * 40); 
                hyperGrid.set(`${hyperX},${hyperTheta}`, { density: 1, lastVisit: globalTick });
            }

            if (isBetaObserver && currentZetaNum < 0.5) {
                const currentAngle = Math.atan2(agent.vy, agent.vx);
                const speedMag = Math.sqrt(agent.vx**2 + agent.vy**2);
                const steerAngle = currentAngle + (Math.random() - 0.5) * 0.1; 
                agent.vx = Math.cos(steerAngle) * speedMag;
                agent.vy = Math.sin(steerAngle) * speedMag;
            }

            agent.trail.push({ x: agent.x, y: agent.y, tick: globalTick });
            if (agent.trail.length > trailLength) agent.trail.shift();

            return { bounced, cornerHit, originCross, zetaNum: currentZetaNum, zetaStr: currentZetaStr };
        }

        function updatePhysics() {
            let swarmHitBoundary = false;
            let triggerArtifact = false;
            let artifactGroup = null;
            let artifactDesc = "";
            let maxDivergence = 0;

            for (let step = 0; step < speed; step++) {
                globalTick++; 
                if(globalTick % 5 === 0) updateBgGrid(); // Update CA Background
                
                fleet.forEach(group => {
                    const alphaRes = moveAgent(group.alpha, false);
                    const betaRes = moveAgent(group.beta, true);

                    if (alphaRes.bounced || betaRes.bounced) {
                        swarmHitBoundary = true;
                        group.bounces++;
                        stats.bounces++; 
                        
                        // TRACKING FOR RATIO / EXHAUSTION
                        if (alphaRes.zetaNum >= 0.5 || betaRes.zetaNum >= 0.5) {
                            lastHighZetaBounce = stats.bounces;
                            zetaStats.high++;
                        } else {
                            zetaStats.low++;
                        }

                        if (alphaRes.cornerHit || betaRes.cornerHit) {
                            stats.cornerHits++;
                            structuredEvents++;
                        }
                        if (alphaRes.originCross || betaRes.originCross) structuredEvents++;

                        stabilityHistory.push(stats.bounces);
                        if (stabilityHistory.length > 5) stabilityHistory.shift();

                        if (supabaseClient) {
                            [ {r: alphaRes, t: 'ALPHA'}, {r: betaRes, t: 'BETA'} ].forEach(evalAgent => {
                                if (evalAgent.r.zetaNum > 0.6) {
                                    let isGlobalTop = false;
                                    if (globalLeaderboard.length < 20) isGlobalTop = true;
                                    else if (evalAgent.r.zetaStr.localeCompare(globalLeaderboard[globalLeaderboard.length - 1].zetaStr) > 0) isGlobalTop = true;

                                    if (isGlobalTop) {
                                        globalLeaderboard.push({ uid: currentUser.uid, swarmId: group.id + 1, type: evalAgent.t, bounce: stats.bounces, zetaStr: evalAgent.r.zetaStr });
                                        globalLeaderboard.sort((a, b) => b.zetaStr.localeCompare(a.zetaStr));
                                        if (globalLeaderboard.length > 20) globalLeaderboard.pop();
                                        supabaseClient.from('global_state').update({ leaderboard_data: { entries: globalLeaderboard } }).eq('id', 'main_leaderboard').then();
                                    }
                                }
                            });
                        }
                    }
                    
                    // SHAPE INVERSION MAPPING: Trigger artifact on geometric events
                    if (!triggerArtifact) {
                        if (alphaRes.cornerHit || betaRes.cornerHit) {
                            triggerArtifact = true;
                            artifactDesc = "PRECISION SINGULARITY: Perfect corner mapped.";
                        } else if (alphaRes.originCross || betaRes.originCross) {
                            triggerArtifact = true;
                            artifactDesc = "SPATIAL INVERSION: Perfect diagonal origin crossing.";
                        }
                        if (triggerArtifact) {
                            // Save exact kinematics for reproducibility!
                            artifactGroup = { 
                                id: group.id, zetaStrAlpha: alphaRes.zetaStr, zetaStrBeta: betaRes.zetaStr,
                                trailAlpha: [...group.alpha.trail], trailBeta: [...group.beta.trail],
                                kinematics: {
                                    alpha: { x: group.alpha.x, y: group.alpha.y, vx: group.alpha.vx, vy: group.alpha.vy },
                                    beta: { x: group.beta.x, y: group.beta.y, vx: group.beta.vx, vy: group.beta.vy }
                                }
                            };
                        }
                    }

                    group.divergence = Math.sqrt(Math.pow(group.alpha.x - group.beta.x, 2) + Math.pow(group.alpha.y - group.beta.y, 2));
                    if (group.divergence > maxDivergence) maxDivergence = group.divergence;
                    
                    // Ratio tracking: High divergence counts as chaotic event
                    if (swarmHitBoundary && group.divergence > 0.3) chaoticEvents++;
                });

                // --- EPOCH ITERATION (AUTO-EXHAUSTION) ---
                // Wait for a massive 81,003 boundary bounces without novelty to allow for deep phase-space re-emergence
                if (stats.bounces > 1000 && (stats.bounces - lastHighZetaBounce) > 81003) {
                    searchEpoch++;
                    baseAngleShift += 0.000137; // Infinitesimal Epsilon Shift
                    lastHighZetaBounce = stats.bounces; // Reset tracker
                    
                    fleet = initializeFleet(baseAngleShift);

                    artifacts.unshift({ 
                        id: `EPOCH-${searchEpoch}`, bounce: stats.bounces, tick: globalTick,
                        triggerSwarm: "ALL", zetaStrAlpha: "0", zetaStrBeta: "0",
                        desc: `PHASE SPACE EXHAUSTED AT 81,003 GAP. Shifting initial configurations by ε=+0.000137.`,
                        trailAlpha: [], trailBeta: [], kinematics: null, gridSnapshot: null
                    });
                    if (artifacts.length > 20) artifacts.pop();
                }

                // Plot ratio history periodically
                if (globalTick % 20 === 0) {
                    let ratio = chaoticEvents === 0 ? structuredEvents : structuredEvents / chaoticEvents;
                    ratioHistory.push(ratio);
                    if (ratioHistory.length > 300) ratioHistory.shift();
                }
            }

            stats.windingNumber = fleet[0].alpha.accumulatedTheta / (2 * Math.PI);

            if (triggerArtifact && artifactGroup && artifacts.length < 20) {
                artifacts.unshift({ 
                    id: `INV-${Math.floor(Math.random()*10000)}`, bounce: stats.bounces, tick: globalTick,
                    triggerSwarm: artifactGroup.id + 1, zetaStrAlpha: artifactGroup.zetaStrAlpha, zetaStrBeta: artifactGroup.zetaStrBeta,
                    desc: artifactDesc, trailAlpha: artifactGroup.trailAlpha, trailBeta: artifactGroup.trailBeta,
                    kinematics: artifactGroup.kinematics
                });
            }

            if (swarmHitBoundary && (stats.bounces - lastSaveBounce >= 200)) {
                const now = Date.now();
                if (now - lastSaveTime > 10000) { 
                    lastSaveBounce = stats.bounces; lastSaveTime = now;
                    saveStateToCloud();
                }
            }

            // --- UI UPDATES ---
            if (swarmHitBoundary || Math.random() < 0.05) {
                document.getElementById('statBounces').innerText = stats.bounces.toLocaleString();
                document.getElementById('statDivergence').innerText = maxDivergence.toFixed(4);
                document.getElementById('statDivergence').className = maxDivergence > 0.5 ? 'text-red-400 font-bold' : 'text-white';
                document.getElementById('statWinding').innerText = stats.windingNumber.toFixed(3);
                document.getElementById('statCorners').innerText = stats.cornerHits.toLocaleString();
                document.getElementById('statEpoch').innerText = searchEpoch;

                if (activeTab === 'SUPER_BRAIN') {
                    if (document.getElementById('super-void')) document.getElementById('super-void').innerText = minOrbitRadius.toFixed(4);
                    if (document.getElementById('swarm-divergence-bars')) {
                        document.getElementById('swarm-divergence-bars').innerHTML = fleet.map(g => `
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-[10px] w-12 text-gray-400">SWRM ${g.id+1}</span>
                                <div class="flex-1 bg-black/50 h-2 rounded border border-gray-700"><div class="bg-cyan-400 h-full transition-all" style="width: ${Math.min(100, g.divergence * 50)}%; box-shadow: 0 0 10px rgba(0,255,255,0.8);"></div></div>
                                <span class="text-[10px] text-cyan-200 w-10 text-right">${g.divergence.toFixed(3)}</span>
                            </div>
                        `).join('');
                    }
                }

                if (activeTab === 'STRUCTURE_RATIO') {
                    document.getElementById('val-structured').innerText = structuredEvents.toLocaleString();
                    document.getElementById('val-chaotic').innerText = chaoticEvents.toLocaleString();
                    let currentRatio = chaoticEvents === 0 ? structuredEvents : structuredEvents/chaoticEvents;
                    document.getElementById('val-ratio').innerText = currentRatio.toFixed(4);

                    // LIVE RE-EMERGENCE TREND ANALYSIS
                    const trendEl = document.getElementById('chaos-trend');
                    if (trendEl && ratioHistory.length > 20) {
                        const recentAvg = ratioHistory.slice(-10).reduce((a,b)=>a+b,0)/10;
                        const oldAvg = ratioHistory.slice(0, 10).reduce((a,b)=>a+b,0)/10;
                        
                        if (recentAvg > oldAvg * 1.05) {
                            trendEl.innerText = "EMERGENCE TREND: ⇧ RE-EMERGING (MORE STRUCTURED)";
                            trendEl.className = "mt-1 text-center text-[10px] font-bold tracking-widest text-lime-400 bg-lime-900/20 p-1 rounded border border-lime-800/50";
                        } else if (recentAvg < oldAvg * 0.95) {
                            trendEl.innerText = "EMERGENCE TREND: ⇩ DEGRADING (MORE CHAOTIC)";
                            trendEl.className = "mt-1 text-center text-[10px] font-bold tracking-widest text-red-400 bg-red-900/20 p-1 rounded border border-red-800/50";
                        } else {
                            trendEl.innerText = "EMERGENCE TREND: ≈ STABLE (INVARIANT BOUNDARY)";
                            trendEl.className = "mt-1 text-center text-[10px] font-bold tracking-widest text-cyan-400 bg-cyan-900/20 p-1 rounded border border-cyan-800/50";
                        }
                    }
                }

                if (activeTab === 'HYPER') {
                    const hd = document.getElementById('hyper-dim');
                    if(hd) hd.innerText = (1.0 + Math.abs(stats.windingNumber * 0.0142)).toFixed(4);
                }
                if (activeTab === 'ZETA') {
                    const zh = document.getElementById('zeta-high');
                    if(zh) zh.innerText = zetaStats.high.toLocaleString();
                    const zl = document.getElementById('zeta-low');
                    if(zl) zl.innerText = zetaStats.low.toLocaleString();
                }

                if (activeTab === 'MUSEUM') {
                    document.getElementById('museum-gallery').innerHTML = artifacts.map(art => `
                        <div onclick="openArtifactModal('${art.id}')" class="cursor-pointer glass-sub-panel hover:bg-yellow-900/40 border-yellow-500/50 p-3 rounded flex flex-col transition-all shadow-[0_0_10px_rgba(255,255,0,0.1)] hover:shadow-[0_0_20px_rgba(255,255,0,0.4)]">
                            <div class="text-white font-bold text-lg">${art.id} <span class="text-[10px] text-yellow-400/80 ml-1">${art.triggerSwarm === 'ALL' ? 'GLOBAL SHIFT' : 'SWRM ' + art.triggerSwarm}</span></div>
                            <div class="text-[9px] text-cyan-300 break-all leading-tight mt-1">α: ${art.zetaStrAlpha.substring(0,25)}...</div>
                            <div class="text-[10px] text-gray-400 font-bold mt-2 border-t border-yellow-900/50 pt-1 uppercase">${art.desc.split(':')[0]}</div>
                        </div>
                    `).join('');
                }

                if (activeTab === 'STABILITY' && swarmHitBoundary) {
                    if (stabilityHistory.length >= 5) {
                        const intervals = [];
                        for(let i=1; i<stabilityHistory.length; i++) intervals.push(stabilityHistory[i] - stabilityHistory[i-1]);
                        const variance = intervals.reduce((a,b)=>a+Math.abs(b-intervals[0]), 0);
                        const isStable = variance < 10;
                        const logHTML = `<div class="${isStable ? 'text-lime-300 font-bold bg-lime-900/40' : 'text-gray-400'} p-2 border-b border-gray-800/80 text-xs">Global: [${intervals.join(', ')}] | Var: ${variance} ${isStable ? '⚡ ORBIT DETECTED' : ''}</div>`;
                        stabilityLogArray.unshift(logHTML);
                        if (stabilityLogArray.length > 30) stabilityLogArray.pop(); 
                        document.getElementById('stability-log').innerHTML = stabilityLogArray.join('');
                    }
                }

                if (activeTab === 'VOIDS') {
                    const vr = document.getElementById('void-radius');
                    if (vr) vr.innerText = minOrbitRadius.toFixed(4);
                }
            }
        }

        // --- 7-COLOR PALETTE ---
        function getRuliadColorState(age, maxAge = 2400) {
            if (age < 5) return '#ffffff';                  // 0/White
            if (age < maxAge * 0.02) return '#00ffff';      // 1/Cyan
            if (age < maxAge * 0.05) return '#00ff88';      // 2/Neon Green
            if (age < maxAge * 0.12) return '#ffff00';      // 3/Yellow
            if (age < maxAge * 0.25) return '#ff8800';      // 4/Orange
            if (age < maxAge * 0.60) return '#ff00ff';      // 5/Magenta
            return '#220044';                               // 6/Purple
        }

        const colorMap = ['#ffffff', '#00ffff', '#00ff88', '#ffff00', '#ff8800', '#ff00ff', '#220044'];

        function renderCanvas() {
            const w = canvas.width; const h = canvas.height;
            const cx = w / 2; const cy = h / 2; const scale = Math.min(w, h) / 2 * 0.9;

            ctx.fillStyle = 'rgba(0, 0, 0, 0.7)'; ctx.fillRect(0, 0, w, h);
            ctx.strokeStyle = '#33ff00'; ctx.lineWidth = 1; ctx.strokeRect(cx - scale, cy - scale, scale * 2, scale * 2);

            const colorBatches = {};
            fleet.forEach(group => {
                [group.alpha, group.beta].forEach(agent => {
                    if (agent.trail.length > 1) {
                        for (let i = 1; i < agent.trail.length; i++) {
                            const color = getRuliadColorState(globalTick - agent.trail[i].tick);
                            if (!colorBatches[color]) colorBatches[color] = [];
                            colorBatches[color].push({ x1: cx + agent.trail[i-1].x * scale, y1: cy + agent.trail[i-1].y * scale, x2: cx + agent.trail[i].x * scale, y2: cy + agent.trail[i].y * scale });
                        }
                    }
                });
            });

            ctx.globalAlpha = 0.9; ctx.lineWidth = 2;
            for (const color in colorBatches) {
                ctx.beginPath();
                colorBatches[color].forEach(line => { ctx.moveTo(line.x1, line.y1); ctx.lineTo(line.x2, line.y2); });
                ctx.strokeStyle = color; ctx.stroke();
            }
            ctx.globalAlpha = 1.0;

            fleet.forEach(group => {
                ctx.beginPath(); ctx.arc(cx + group.alpha.x * scale, cy + group.alpha.y * scale, 3, 0, 2 * Math.PI); ctx.fillStyle = '#ffffff'; ctx.fill(); ctx.closePath();
                ctx.beginPath(); ctx.arc(cx + group.beta.x * scale, cy + group.beta.y * scale, 3, 0, 2 * Math.PI); ctx.fillStyle = '#ff00ff'; ctx.fill(); ctx.closePath();
            });

            if (activeTab === 'STRUCTURE_RATIO' && ratioCanvas) {
                const rCtx = ratioCanvas.getContext('2d');
                const rw = ratioCanvas.width; const rh = ratioCanvas.height;
                rCtx.clearRect(0, 0, rw, rh);
                if (ratioHistory.length > 1) {
                    const maxRatio = Math.max(...ratioHistory, 1.0);
                    rCtx.beginPath();
                    for (let i=0; i<ratioHistory.length; i++) {
                        const x = (i / 300) * rw;
                        const y = rh - (ratioHistory[i] / maxRatio) * rh;
                        if (i===0) rCtx.moveTo(x, y); else rCtx.lineTo(x, y);
                    }
                    rCtx.strokeStyle = '#ff00ff'; rCtx.lineWidth = 2; rCtx.stroke();
                    // Fill gradient
                    rCtx.lineTo(rw, rh); rCtx.lineTo(0, rh);
                    const grad = rCtx.createLinearGradient(0,0,0,rh);
                    grad.addColorStop(0, 'rgba(255,0,255,0.4)'); grad.addColorStop(1, 'rgba(0,0,0,0)');
                    rCtx.fillStyle = grad; rCtx.fill();
                }
            }

            if (activeTab === 'EYES' && eyesCanvas) {
                const eCtx = eyesCanvas.getContext('2d');
                eCtx.clearRect(0, 0, eyesCanvas.width, eyesCanvas.height);
                const ew = eyesCanvas.width; const eh = eyesCanvas.height;
                const gridSize = 40; const cellW = ew / gridSize; const cellH = eh / gridSize;
                
                visitedGrid.forEach((cell, key) => {
                    const [gx, gy] = key.split(',').map(Number);
                    let age = globalTick - cell.lastVisit;
                    let displayAge = age;
                    
                    if (cell.density > 2) {
                        const timeMod = Math.floor(globalTick * 0.15); 
                        const magicHash = (gx ^ gy ^ timeMod) % 25;
                        if (magicHash === 0) displayAge = 2; 
                        else if (magicHash < 3) displayAge = 40; 
                        else if (cell.density > 8 && (gx * gy + timeMod) % 15 === 0) displayAge = 200; 
                    }
                    eCtx.fillStyle = getRuliadColorState(displayAge);
                    eCtx.fillRect((gx/gridSize)*ew + 1, (gy/gridSize)*eh + 1, cellW - 2, cellH - 2);
                });
            }

            if (activeTab === 'HYPER' && hyperCanvas) {
                const hCtx = hyperCanvas.getContext('2d');
                hCtx.clearRect(0, 0, hyperCanvas.width, hyperCanvas.height);
                const hw = hyperCanvas.width; const hh = hyperCanvas.height;
                const hCellW = hw / 40; const hCellH = hh / 40;

                hyperGrid.forEach((cell, key) => {
                    const [gx, gy] = key.split(',').map(Number);
                    hCtx.fillStyle = getRuliadColorState(globalTick - cell.lastVisit);
                    hCtx.fillRect((gx/40)*hw + 1, (gy/40)*hh + 1, hCellW - 2, hCellH - 2);
                });
            }

            if (activeTab === 'ZETA' && zetaCanvas) {
                const zCtx = zetaCanvas.getContext('2d');
                zCtx.clearRect(0, 0, zetaCanvas.width, zetaCanvas.height);
                const zw = zetaCanvas.width; const zh = zetaCanvas.height;
                const zCellW = zw / 8; const zCellH = zh / 8;

                for (let ix = 0; ix < 8; ix++) {
                    for (let iy = 0; iy < 8; iy++) {
                        const weight = Math.abs(Math.sin((ix+1) * fleet[0].beta.x * 3.14 + (iy+1) * fleet[0].beta.y * 2.71 + globalTick * 0.005));
                        zCtx.fillStyle = getRuliadColorState((1.0 - weight) * 2400);
                        zCtx.fillRect((ix/8)*zw + 1, (iy/8)*zh + 1, zCellW - 2, zCellH - 2);
                    }
                }
            }

            // LIVE CYCLIC CELLULAR AUTOMATON BACKGROUND (Wolfram Style Reacting 2D Grid)
            if (globalBgCanvas && bgCols > 0) {
                const bgCtx = globalBgCanvas.getContext('2d');
                const bgW = bgCtx.canvas.width; const bgH = bgCtx.canvas.height;
                
                bgCtx.fillStyle = 'rgba(0, 0, 0, 0.4)';
                bgCtx.fillRect(0, 0, bgW, bgH);

                for (let x = 0; x < bgCols; x++) {
                    for (let y = 0; y < bgRows; y++) {
                        let state = bgGridCA[x][y];
                        if (state < 6) { 
                            bgCtx.fillStyle = colorMap[state];
                            bgCtx.fillRect(x * BG_CELL_SIZE, y * BG_CELL_SIZE, BG_CELL_SIZE - 2, BG_CELL_SIZE - 2);
                        }
                    }
                }
            }
        }

        function loop() {
            updatePhysics();
            renderCanvas();
            requestAnimationFrame(loop);
        }

        async function initSupabaseAndStart() {
            try {
                const SUPABASE_URL = "https://xoolmbmnzbsvcqeyqvyi.supabase.co";
                const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhvb2xtYm1uemJzdmNxZXlxdnlpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0NDMwNDQsImV4cCI6MjA4NzAxOTA0NH0.ebTwMZ_byU6EXtuR0jynct64QO5ornQrCwElQ5b9TxQ";

                supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

                let localUid = localStorage.getItem('ruliad_uid');
                if (!localUid) {
                    localUid = 'USR-' + crypto.randomUUID();
                    localStorage.setItem('ruliad_uid', localUid);
                }
                currentUser = { uid: localUid };

                await loadStateFromCloud();
                await setupGlobalLeaderboardListener();
                
                document.getElementById('save-status').innerText = 'MULTIWAY SYNCED';
                document.getElementById('save-status').className = 'text-lime-500 font-bold';
                
                if (!isLoopRunning) {
                    isLoopRunning = true;
                    setupUI();
                    requestAnimationFrame(loop);
                }
            } catch (e) {
                console.error("Cloud Sync Setup Error:", e);
                document.getElementById('save-status').innerText = 'LOCAL ONLY (UNSAVED)';
                document.getElementById('save-status').className = 'text-red-500 font-bold';
                if (!isLoopRunning) {
                    isLoopRunning = true;
                    setupUI();
                    requestAnimationFrame(loop);
                }
            }
        }

        window.onload = initSupabaseAndStart;
    </script>
</body>
</html>